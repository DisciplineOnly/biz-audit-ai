---
phase: 04-rate-limiting
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - supabase/functions/generate-report/index.ts
autonomous: false
requirements: [SEC-01]

user_setup:
  - service: upstash
    why: "Redis-backed rate limiting for audit submissions"
    env_vars:
      - name: UPSTASH_REDIS_REST_URL
        source: "Upstash Console (console.upstash.com) → Create Database → REST API section → UPSTASH_REDIS_REST_URL"
      - name: UPSTASH_REDIS_REST_TOKEN
        source: "Upstash Console (console.upstash.com) → Create Database → REST API section → UPSTASH_REDIS_REST_TOKEN"
    dashboard_config:
      - task: "Create free Redis database"
        location: "Upstash Console → Create Database → select nearest region → Free tier"
      - task: "Add secrets to Supabase"
        location: "Supabase Dashboard → Project Settings → Edge Functions → Secrets → add UPSTASH_REDIS_REST_URL and UPSTASH_REDIS_REST_TOKEN"

must_haves:
  truths:
    - "Submitting 4 audits from the same email within 24 hours causes the 4th to receive a 429 response"
    - "Submitting audits from different email addresses succeeds without restriction"
    - "Rate limit counters reset after 24 hours so a previously blocked email can submit again"
    - "429 response includes friendly message with approximate time hint"
  artifacts:
    - path: "supabase/functions/generate-report/index.ts"
      provides: "Deployed edge function with working rate limiting"
  key_links:
    - from: "supabase/functions/generate-report/index.ts"
      to: "Upstash Redis"
      via: "UPSTASH_REDIS_REST_URL and UPSTASH_REDIS_REST_TOKEN secrets"
      pattern: "Deno\\.env\\.get\\('UPSTASH_REDIS_REST_URL'\\)"
---

<objective>
Deploy the rate-limited generate-report edge function and verify all 3 Phase 4 success criteria via curl testing.

Purpose: Confirm SEC-01 enforcement is live — the deployed edge function actually rejects the 4th submission from the same email with a 429 and friendly message. This requires the user to first set up an Upstash Redis database and configure the secrets in Supabase.

Output: Deployed and verified rate-limited edge function
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-rate-limiting/04-CONTEXT.md
@.planning/phases/04-rate-limiting/04-RESEARCH.md
@.planning/phases/04-rate-limiting/04-01-SUMMARY.md
@supabase/functions/generate-report/index.ts
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create Upstash Redis database and configure Supabase secrets</name>
  <action>
The user must create an Upstash Redis database and add the credentials as Supabase edge function secrets. Claude cannot perform this step — it requires account creation on an external service.
  </action>
  <how-to-verify>
**Step 1: Create Upstash Redis database**
1. Go to https://console.upstash.com (create account if needed — free tier, no credit card)
2. Click "Create Database"
3. Name it something like "bizaudit-ratelimit"
4. Select the region closest to your Supabase project (check Supabase Dashboard → Settings → General for project region)
5. Select Free tier (500K commands/month — more than enough for pre-launch)
6. Click Create

**Step 2: Copy REST API credentials**
1. On the database page, scroll to the "REST API" section
2. Copy `UPSTASH_REDIS_REST_URL` (starts with `https://`)
3. Copy `UPSTASH_REDIS_REST_TOKEN` (long alphanumeric string)

**Step 3: Add secrets to Supabase**
1. Go to Supabase Dashboard → Project Settings → Edge Functions → Secrets
2. Add secret: `UPSTASH_REDIS_REST_URL` = the URL from Step 2
3. Add secret: `UPSTASH_REDIS_REST_TOKEN` = the token from Step 2
4. Save

**Alternatively via CLI:**
```bash
supabase secrets set UPSTASH_REDIS_REST_URL=https://your-instance.upstash.io
supabase secrets set UPSTASH_REDIS_REST_TOKEN=your-token-here
```
  </how-to-verify>
  <resume-signal>Type "secrets configured" when both UPSTASH_REDIS_REST_URL and UPSTASH_REDIS_REST_TOKEN are saved in Supabase secrets</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Deploy generate-report edge function and verify rate limiting via curl</name>
  <files>supabase/functions/generate-report/index.ts</files>
  <action>
Deploy the updated generate-report edge function (now with rate limiting) to Supabase and verify all 3 Phase 4 success criteria.

**Deployment:**
Deploy via Supabase MCP (same pattern as Phase 2 — executor may need orchestrator MCP access). The edge function file is `supabase/functions/generate-report/index.ts`.

NOTE: MCP deploy requires inlining the corsHeaders constant (MCP cannot resolve `../_shared/cors.ts` import). This was established in Phase 3 (03-03 decision). If deploying via MCP, replace the `import { corsHeaders } from '../_shared/cors.ts'` with the inline constant:
```typescript
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}
```
Keep the shared import in the local file for CLI deploy compatibility.

**Verification via curl (all 3 success criteria):**

Use the Supabase project URL and anon key from the project's .env file. The edge function URL is `https://{SUPABASE_URL}/functions/v1/generate-report`.

**Criterion 1: 4th submission from same email gets 429**
Send 4 curl requests with the same email address. The first 3 should return 200, the 4th should return 429.

```bash
# Minimal payload — just enough for rate limit check to work
# Use a unique test email each test run to avoid hitting prior limits
PAYLOAD='{"auditId":"test-rl-'$(date +%s)'","formState":{"niche":"home_services","step1":{"businessName":"Rate Limit Test","email":"ratelimit-test-'$(date +%s)'@example.com","contactName":"Test"},"step2":{},"step3":{},"step4":{},"step5":{},"step6":{},"step7":{},"step8":{}},"scores":{"technology":50,"leads":50,"scheduling":50,"communication":50,"followUp":50,"operations":50,"financial":50,"overall":50,"categories":[{"category":"technology","label":"Technology","score":50,"weight":15},{"category":"leads","label":"Leads","score":50,"weight":20},{"category":"scheduling","label":"Scheduling","score":50,"weight":15},{"category":"communication","label":"Communication","score":50,"weight":10},{"category":"followUp","label":"Follow-Up","score":50,"weight":15},{"category":"operations","label":"Operations","score":50,"weight":10},{"category":"financial","label":"Financial","score":50,"weight":15}]}}'

# Send requests 1-3 (should all return 200)
for i in 1 2 3; do
  echo "Request $i:"
  curl -s -o /dev/null -w "HTTP %{http_code}" -X POST \
    "${SUPABASE_URL}/functions/v1/generate-report" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer ${ANON_KEY}" \
    -d "$PAYLOAD"
  echo ""
done

# Request 4 (should return 429)
echo "Request 4 (expect 429):"
curl -s -X POST \
  "${SUPABASE_URL}/functions/v1/generate-report" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ${ANON_KEY}" \
  -d "$PAYLOAD"
```

Expected: Requests 1-3 return HTTP 200, Request 4 returns HTTP 429 with body `{"rateLimited":true,"message":"You've already submitted 3 audits today. Try again ..."}`.

**Criterion 2: Different emails succeed without restriction**
Send a request with a DIFFERENT email address after the 4th was blocked.

```bash
PAYLOAD2='{"auditId":"test-rl2-'$(date +%s)'","formState":{"niche":"home_services","step1":{"businessName":"Different Email Test","email":"different-'$(date +%s)'@example.com","contactName":"Test2"},"step2":{},"step3":{},"step4":{},"step5":{},"step6":{},"step7":{},"step8":{}},"scores":{"technology":50,"leads":50,"scheduling":50,"communication":50,"followUp":50,"operations":50,"financial":50,"overall":50,"categories":[]}}'

curl -s -o /dev/null -w "HTTP %{http_code}" -X POST \
  "${SUPABASE_URL}/functions/v1/generate-report" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ${ANON_KEY}" \
  -d "$PAYLOAD2"
```

Expected: HTTP 200.

**Criterion 3: Rate limit resets after 24 hours**
This cannot be verified in real-time (would require waiting 24 hours). Verify by code inspection:
- Confirm `fixedWindow(3, '24 h')` is used — Upstash's fixedWindow automatically expires counters at window boundary
- Confirm no manual TTL or expiry logic that could prevent reset
- Document: "24h reset verified by code inspection — fixedWindow algorithm uses Redis key TTL which auto-expires"

**If any curl request fails with a non-429 error (e.g., 500, connection refused):**
- Check Supabase edge function logs for errors
- Common issues: UPSTASH_REDIS_REST_URL or UPSTASH_REDIS_REST_TOKEN not set → Redis connection error
- Verify secrets are correctly configured in Supabase Dashboard
  </action>
  <verify>
1. curl request 4 with same email returns HTTP 429 with `rateLimited: true` and message containing approximate time hint
2. curl request with different email returns HTTP 200 after the blocked email was rate-limited
3. Code confirms `fixedWindow(3, '24 h')` for email and `fixedWindow(10, '24 h')` for IP
4. 429 response body does NOT contain "email" or "IP" — same generic message regardless of which limit hit
  </verify>
  <done>
All 3 Phase 4 success criteria confirmed:
1. 4th submission from same email returns 429 with friendly message
2. Different email succeeds without restriction
3. 24h reset confirmed via fixedWindow algorithm (auto-expiring Redis keys)
  </done>
</task>

</tasks>

<verification>
- [ ] Upstash Redis database created and secrets configured in Supabase
- [ ] generate-report edge function deployed with rate limiting code
- [ ] 4th curl request with same email returns 429 with `{ rateLimited: true, message: "..." }`
- [ ] Request with different email after blocked email still returns 200
- [ ] 429 message includes approximate time hint (not exact timestamp)
- [ ] 429 message is the same regardless of whether email or IP limit triggered
- [ ] fixedWindow('24 h') confirmed in code — 24h reset via Redis TTL
</verification>

<success_criteria>
The deployed generate-report edge function enforces SEC-01: email-based rate limiting at 3/24h and IP-based rate limiting at 10/24h, verified by curl tests showing 429 rejection on the 4th same-email submission and successful submission from a different email.
</success_criteria>

<output>
After completion, create `.planning/phases/04-rate-limiting/04-02-SUMMARY.md`
</output>
