---
phase: 08-sub-niche-config-and-selection-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/audit.ts
  - src/config/subNicheConfig.ts
autonomous: true
requirements:
  - SUBN-08

must_haves:
  truths:
    - "A SubNiche type exists as a discriminated union of all 17 sub-niche string literals"
    - "A SubNicheGroup type exists mapping HS sub-niches to 3 groups (reactive, recurring, project_based) and RE sub-niches to their individual identifiers"
    - "AuditFormState has a subNiche field of type SubNiche | null"
    - "auditReducer handles SET_SUB_NICHE action"
    - "A SubNicheConfig interface defines the shape of per-sub-niche option overrides (crms, tools, leadSources, kpis)"
    - "A subNicheRegistry maps every SubNiche to its SubNicheGroup and display metadata (label, icon/emoji)"
    - "npm run build succeeds with zero errors"
  artifacts:
    - path: "src/types/audit.ts"
      provides: "SubNiche type, SubNicheGroup type, subNiche field in AuditFormState, SET_SUB_NICHE action"
      contains: "SubNiche"
    - path: "src/config/subNicheConfig.ts"
      provides: "SubNicheConfig interface, SubNicheGroup enum/type, subNicheRegistry mapping, getSubNicheGroup helper"
      contains: "SubNicheConfig"
  key_links:
    - from: "src/types/audit.ts"
      to: "src/config/subNicheConfig.ts"
      via: "SubNiche type used in both files"
      pattern: "SubNiche"
---

<objective>
Define the TypeScript types and config schema for sub-niche specialization. Add `subNiche` to `AuditFormState` with a `SET_SUB_NICHE` reducer action. Create the config file with the `SubNicheConfig` interface, the sub-niche registry (mapping each of the 17 sub-niches to its group, label, and emoji), and a `getSubNicheGroup()` helper.

Purpose: This is the foundational type and schema plan for Phase 8. All subsequent plans depend on these types being defined. The config schema determines the shape that option data will fill in 08-03.
Output: Working type definitions, empty-but-typed config structure, and state management integration.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-sub-niche-config-and-selection-ui/08-CONTEXT.md
@.planning/research/FEATURES.md
@.planning/research/ARCHITECTURE.md
@src/types/audit.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define SubNiche types and add to AuditFormState</name>
  <files>
    src/types/audit.ts
  </files>
  <action>
1. Add the following types at the top of `src/types/audit.ts` (before the existing `Niche` type):

   ```typescript
   /** All 12 Home Services sub-niches */
   export type HSSubNiche =
     | "hvac" | "plumbing" | "electrical" | "garage_doors"       // Group A: Reactive Service
     | "pest_control" | "landscaping" | "cleaning"               // Group B: Recurring/Scheduled
     | "roofing" | "painting" | "general_contracting"            // Group C: Project-Based
     | "construction" | "interior_design";                       // Group C: Project-Based

   /** All 5 Real Estate sub-niches */
   export type RESubNiche =
     | "residential_sales" | "commercial" | "property_management"
     | "new_construction" | "luxury_resort";

   /** Union of all sub-niches */
   export type SubNiche = HSSubNiche | RESubNiche;
   ```

2. Add `subNiche` field to `AuditFormState`:
   ```typescript
   export interface AuditFormState {
     niche: Niche | null;
     subNiche: SubNiche | null;   // <-- NEW
     currentStep: number;
     // ... rest unchanged
   ```

3. Update `initialFormState` to include `subNiche: null` after `niche: null`.

4. Add `SET_SUB_NICHE` action to `AuditAction` union:
   ```typescript
   | { type: "SET_SUB_NICHE"; payload: SubNiche }
   ```

5. Add the reducer case in `auditReducer` switch:
   ```typescript
   case "SET_SUB_NICHE":
     return { ...state, subNiche: action.payload };
   ```

6. **Important**: When `SET_NICHE` is dispatched and the niche changes, also reset `subNiche` to `null`. Update the `SET_NICHE` case:
   ```typescript
   case "SET_NICHE":
     return { ...state, niche: action.payload, subNiche: null };
   ```
  </action>
  <verify>
- `npm run build` succeeds
- `SubNiche` type is exported from `src/types/audit.ts`
- `AuditFormState` has `subNiche: SubNiche | null`
- `auditReducer` handles `SET_SUB_NICHE` action
- `SET_NICHE` resets `subNiche` to null
  </verify>
  <done>SubNiche types (HSSubNiche, RESubNiche, SubNiche union) and SET_SUB_NICHE action added to AuditFormState and auditReducer. SET_NICHE resets subNiche to null for clean state transitions.</done>
</task>

<task type="auto">
  <name>Task 2: Create sub-niche config schema and registry</name>
  <files>
    src/config/subNicheConfig.ts
  </files>
  <action>
1. Create `src/config/subNicheConfig.ts` with the following structure:

   ```typescript
   import { HSSubNiche, RESubNiche, SubNiche } from "@/types/audit";

   /**
    * HS sub-niches are grouped by operational similarity to reduce config duplication.
    * RE sub-niches each have their own config.
    */
   export type HSSubNicheGroup = "reactive" | "recurring" | "project_based";
   export type SubNicheGroup = HSSubNicheGroup | RESubNiche;

   /** Maps each HS sub-niche to its group */
   const HS_GROUP_MAP: Record<HSSubNiche, HSSubNicheGroup> = {
     hvac: "reactive",
     plumbing: "reactive",
     electrical: "reactive",
     garage_doors: "reactive",
     pest_control: "recurring",
     landscaping: "recurring",
     cleaning: "recurring",
     roofing: "project_based",
     painting: "project_based",
     general_contracting: "project_based",
     construction: "project_based",
     interior_design: "project_based",
   };

   /** Display metadata for each sub-niche */
   export interface SubNicheInfo {
     id: SubNiche;
     labelKey: string;       // i18n key for display label (Phase 11 uses this)
     label: string;          // English fallback label
     emoji: string;          // Visual identifier for card grid
     niche: "home_services" | "real_estate";
   }

   /** Registry of all 17 sub-niches with display metadata */
   export const SUB_NICHE_REGISTRY: SubNicheInfo[] = [
     // Home Services â€” Group A: Reactive
     { id: "hvac", labelKey: "subNiche.hvac", label: "HVAC", emoji: "â„ï¸", niche: "home_services" },
     { id: "plumbing", labelKey: "subNiche.plumbing", label: "Plumbing", emoji: "ðŸ”§", niche: "home_services" },
     { id: "electrical", labelKey: "subNiche.electrical", label: "Electrical", emoji: "âš¡", niche: "home_services" },
     { id: "garage_doors", labelKey: "subNiche.garageDoors", label: "Garage Doors", emoji: "ðŸšª", niche: "home_services" },
     // Home Services â€” Group B: Recurring
     { id: "pest_control", labelKey: "subNiche.pestControl", label: "Pest Control", emoji: "ðŸ›", niche: "home_services" },
     { id: "landscaping", labelKey: "subNiche.landscaping", label: "Landscaping", emoji: "ðŸŒ¿", niche: "home_services" },
     { id: "cleaning", labelKey: "subNiche.cleaning", label: "Cleaning", emoji: "ðŸ§¹", niche: "home_services" },
     // Home Services â€” Group C: Project-Based
     { id: "roofing", labelKey: "subNiche.roofing", label: "Roofing", emoji: "ðŸ—ï¸", niche: "home_services" },
     { id: "painting", labelKey: "subNiche.painting", label: "Painting", emoji: "ðŸŽ¨", niche: "home_services" },
     { id: "general_contracting", labelKey: "subNiche.generalContracting", label: "General Contracting", emoji: "ðŸ”¨", niche: "home_services" },
     { id: "construction", labelKey: "subNiche.construction", label: "Construction", emoji: "ðŸ¢", niche: "home_services" },
     { id: "interior_design", labelKey: "subNiche.interiorDesign", label: "Interior Design", emoji: "ðŸ›‹ï¸", niche: "home_services" },
     // Real Estate
     { id: "residential_sales", labelKey: "subNiche.residentialSales", label: "Residential Sales", emoji: "ðŸ ", niche: "real_estate" },
     { id: "commercial", labelKey: "subNiche.commercial", label: "Commercial / Office", emoji: "ðŸ¬", niche: "real_estate" },
     { id: "property_management", labelKey: "subNiche.propertyManagement", label: "Property Management", emoji: "ðŸ”‘", niche: "real_estate" },
     { id: "new_construction", labelKey: "subNiche.newConstruction", label: "New Construction", emoji: "ðŸ—ï¸", niche: "real_estate" },
     { id: "luxury_resort", labelKey: "subNiche.luxuryResort", label: "Luxury / Resort", emoji: "ðŸ’Ž", niche: "real_estate" },
   ];

   /** Option overrides for a sub-niche group. Arrays are ADDITIONS to the base niche list. */
   export interface SubNicheOptions {
     /** CRM options â€” replaces the entire base CRM list for this group */
     crms: string[];
     /** Additional tools to add to the base tools checklist */
     toolsExtra: string[];
     /** Lead source options â€” replaces the entire base lead source list for this group */
     leadSources: string[];
     /** KPI options â€” replaces the entire base KPI list for this group */
     kpis: string[];
   }

   /**
    * Config map: SubNicheGroup -> option overrides.
    * HS sub-niches share options via their group (reactive/recurring/project_based).
    * RE sub-niches each have their own entry.
    * Populated in 08-03.
    */
   export const SUB_NICHE_OPTIONS: Record<SubNicheGroup, SubNicheOptions> = {
     // HS Groups â€” populated in 08-03
     reactive: { crms: [], toolsExtra: [], leadSources: [], kpis: [] },
     recurring: { crms: [], toolsExtra: [], leadSources: [], kpis: [] },
     project_based: { crms: [], toolsExtra: [], leadSources: [], kpis: [] },
     // RE Sub-niches â€” populated in 08-03
     residential_sales: { crms: [], toolsExtra: [], leadSources: [], kpis: [] },
     commercial: { crms: [], toolsExtra: [], leadSources: [], kpis: [] },
     property_management: { crms: [], toolsExtra: [], leadSources: [], kpis: [] },
     new_construction: { crms: [], toolsExtra: [], leadSources: [], kpis: [] },
     luxury_resort: { crms: [], toolsExtra: [], leadSources: [], kpis: [] },
   };

   /** Get the sub-niche group for option lookups */
   export function getSubNicheGroup(subNiche: SubNiche): SubNicheGroup {
     if (subNiche in HS_GROUP_MAP) {
       return HS_GROUP_MAP[subNiche as HSSubNiche];
     }
     // RE sub-niches are their own group
     return subNiche as RESubNiche;
   }

   /** Get sub-niches filtered by niche */
   export function getSubNichesForNiche(niche: "home_services" | "real_estate"): SubNicheInfo[] {
     return SUB_NICHE_REGISTRY.filter((sn) => sn.niche === niche);
   }

   /** Get the option overrides for a given sub-niche */
   export function getSubNicheOptions(subNiche: SubNiche): SubNicheOptions {
     const group = getSubNicheGroup(subNiche);
     return SUB_NICHE_OPTIONS[group];
   }
   ```

2. Ensure the `src/config/` directory exists before creating the file.
  </action>
  <verify>
- `npm run build` succeeds
- `src/config/subNicheConfig.ts` exports SubNicheGroup, SubNicheInfo, SubNicheOptions, SUB_NICHE_REGISTRY, SUB_NICHE_OPTIONS, getSubNicheGroup, getSubNichesForNiche, getSubNicheOptions
- All 17 sub-niches appear in SUB_NICHE_REGISTRY
- HS_GROUP_MAP maps all 12 HS sub-niches to their 3 groups
- getSubNicheGroup returns correct group for each sub-niche
  </verify>
  <done>Sub-niche config schema created at src/config/subNicheConfig.ts. Defines SubNicheGroup type, SubNicheInfo metadata, SubNicheOptions interface, registry of all 17 sub-niches with display metadata, and helper functions for group lookup. Option arrays are placeholder-empty, ready for population in 08-03.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run test` passes (no existing tests broken)
3. `SubNiche`, `HSSubNiche`, `RESubNiche` types are exported from `src/types/audit.ts`
4. `AuditFormState.subNiche` exists as `SubNiche | null`
5. `SET_SUB_NICHE` action is handled by `auditReducer`
6. `src/config/subNicheConfig.ts` exports all types, constants, and functions
7. All 17 sub-niches are present in `SUB_NICHE_REGISTRY`
8. `getSubNicheGroup("hvac")` returns `"reactive"`, `getSubNicheGroup("residential_sales")` returns `"residential_sales"`
</verification>

<success_criteria>
- SubNiche type system covers all 17 sub-niches from the roadmap
- AuditFormState integrates subNiche with proper reset on niche change
- Config schema supports the grouping strategy (3 HS groups, 5 individual RE sub-niches = 8 config entries)
- SubNicheOptions interface defines clear fields for crms, toolsExtra, leadSources, kpis
- Helper functions abstract the group lookup so consuming code never needs to know about grouping internals
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-sub-niche-config-and-selection-ui/08-01-SUMMARY.md`
</output>
