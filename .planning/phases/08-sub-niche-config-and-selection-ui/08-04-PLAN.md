---
phase: 08-sub-niche-config-and-selection-ui
plan: 04
type: execute
wave: 4
depends_on: ["08-02", "08-03"]
files_modified:
  - src/components/audit/Step2Technology.tsx
  - src/components/audit/Step3LeadFunnel.tsx
  - src/components/audit/Step7Operations.tsx
  - src/components/audit/AuditFormComponents.tsx
autonomous: true
requirements:
  - SUBN-03
  - SUBN-04
  - SUBN-05
  - SUBN-07

must_haves:
  truths:
    - "Step 2 CRM options change based on the selected sub-niche"
    - "Step 2 tools checklist shows base niche tools PLUS sub-niche-specific extras"
    - "Step 3 lead source options change based on the selected sub-niche"
    - "Step 7 KPI options change based on the selected sub-niche"
    - "When no sub-niche is selected (null), the original base niche options are shown (backward compatible)"
    - "StepProps now includes subNiche so step components can read it"
    - "Scoring is not broken — all option values that exist in scoring lookup tables use the exact same strings"
    - "npm run build succeeds with zero errors"
  artifacts:
    - path: "src/components/audit/Step2Technology.tsx"
      provides: "Sub-niche-aware CRM and tools options"
      contains: "getSubNicheOptions"
    - path: "src/components/audit/Step3LeadFunnel.tsx"
      provides: "Sub-niche-aware lead source options"
      contains: "getSubNicheOptions"
    - path: "src/components/audit/Step7Operations.tsx"
      provides: "Sub-niche-aware KPI options"
      contains: "getSubNicheOptions"
  key_links:
    - from: "src/components/audit/Step2Technology.tsx"
      to: "src/config/subNicheConfig.ts"
      via: "getSubNicheOptions"
      pattern: "getSubNicheOptions"
    - from: "src/components/audit/Step3LeadFunnel.tsx"
      to: "src/config/subNicheConfig.ts"
      via: "getSubNicheOptions"
      pattern: "getSubNicheOptions"
    - from: "src/components/audit/Step7Operations.tsx"
      to: "src/config/subNicheConfig.ts"
      via: "getSubNicheOptions"
      pattern: "getSubNicheOptions"
---

<objective>
Wire Steps 2, 3, and 7 to read option arrays from the sub-niche config instead of their current inline arrays when a sub-niche is selected. Pass `subNiche` through `StepProps` so step components can access it.

Purpose: This plan connects the config data (08-03) to the UI components. After this, users selecting different sub-niches will see different CRM, lead source, and KPI options — the core differentiation that Phase 8 delivers.
Output: Steps 2, 3, and 7 adapt their option lists based on the selected sub-niche.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-sub-niche-config-and-selection-ui/08-CONTEXT.md
@src/config/subNicheConfig.ts
@src/components/audit/AuditFormComponents.tsx
@src/components/audit/Step2Technology.tsx
@src/components/audit/Step3LeadFunnel.tsx
@src/components/audit/Step7Operations.tsx
@src/pages/AuditForm.tsx
@src/lib/scoring.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pass subNiche through StepProps and update AuditForm</name>
  <files>
    src/components/audit/AuditFormComponents.tsx
    src/pages/AuditForm.tsx
  </files>
  <action>
1. **No change to StepProps interface** — `StepProps` already has `state: AuditFormState`, and `state.subNiche` is available after 08-01. Step components access sub-niche via `state.subNiche`. No additional prop is needed.

   Verify that `stepProps` in `AuditForm.tsx` (line 157: `const stepProps = { state, dispatch, isHS };`) passes the full `state` object which already includes `subNiche` after 08-01. No change needed here.

2. The key insight is that step components should use a helper function to determine which options to show:
   - If `state.subNiche` is not null, use `getSubNicheOptions(state.subNiche)` to get the sub-niche-specific options
   - If `state.subNiche` is null (shouldn't happen after 08-02 validation, but defensive), fall back to the original base arrays

   Each step component will implement this pattern internally.
  </action>
  <verify>
- `state.subNiche` is accessible in all step components via `StepProps.state`
- No prop drilling needed beyond existing StepProps
  </verify>
  <done>Confirmed StepProps already provides subNiche access via state.subNiche. No interface changes needed.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Step 2 (Technology) to sub-niche config</name>
  <files>
    src/components/audit/Step2Technology.tsx
  </files>
  <action>
1. Add import at the top of Step2Technology.tsx:
   ```typescript
   import { getSubNicheOptions } from "@/config/subNicheConfig";
   ```

2. Inside the `Step2Technology` component function, after the existing destructuring, add the sub-niche option resolution:

   ```typescript
   // Sub-niche-aware option resolution
   const subNicheOpts = state.subNiche ? getSubNicheOptions(state.subNiche) : null;

   // CRM options: sub-niche replaces base list entirely
   const crmOptions = subNicheOpts && subNicheOpts.crms.length > 0
     ? toOptions(subNicheOpts.crms)
     : (isHS ? HS_CRMS : RE_CRMS);

   // Tools: base list + sub-niche extras appended
   const baseTools = isHS ? HS_TOOLS : RE_TOOLS;
   const toolOptions = subNicheOpts && subNicheOpts.toolsExtra.length > 0
     ? [...baseTools, ...toOptions(subNicheOpts.toolsExtra)]
     : baseTools;
   ```

3. Update the JSX to use the computed `crmOptions` and `toolOptions` instead of the inline conditional:

   Replace `options={isHS ? HS_CRMS : RE_CRMS}` in the CRM StyledSelect with:
   ```tsx
   options={crmOptions}
   ```

   Replace `options={isHS ? HS_TOOLS : RE_TOOLS}` in the MultiCheckbox with:
   ```tsx
   options={toolOptions}
   ```

4. The existing inline `HS_CRMS`, `RE_CRMS`, `HS_TOOLS`, `RE_TOOLS` constants remain in the file as fallbacks — they are used when `subNiche` is null.
  </action>
  <verify>
- `npm run build` succeeds
- With HVAC selected as sub-niche, Step 2 CRM dropdown shows ServiceTitan, Housecall Pro, Jobber, FieldEdge, etc.
- With Pest Control selected, Step 2 CRM dropdown shows GorillaDesk, ZenMaid, Pocomos, etc.
- With Construction selected, Step 2 CRM dropdown shows Buildertrend, Procore, JobTread, etc.
- With no sub-niche selected (null), Step 2 shows the original HS_CRMS or RE_CRMS list
- Tools checklist for project_based sub-niches shows extra tools (BIM/CAD, etc.) appended to the base list
  </verify>
  <done>Step 2 wired to sub-niche config. CRM dropdown shows sub-niche-specific options. Tools checklist appends sub-niche extras to base list. Falls back to base niche lists when no sub-niche is selected.</done>
</task>

<task type="auto">
  <name>Task 3: Wire Step 3 (Lead Funnel) to sub-niche config</name>
  <files>
    src/components/audit/Step3LeadFunnel.tsx
  </files>
  <action>
1. Add import:
   ```typescript
   import { getSubNicheOptions } from "@/config/subNicheConfig";
   ```

2. Inside the component, add sub-niche option resolution:

   ```typescript
   // Sub-niche-aware lead source options
   const subNicheOpts = state.subNiche ? getSubNicheOptions(state.subNiche) : null;

   const leadSourceOptions = subNicheOpts && subNicheOpts.leadSources.length > 0
     ? toOptions(subNicheOpts.leadSources)
     : (isHS ? HS_LEAD_SOURCES : RE_LEAD_SOURCES);
   ```

3. Update the lead sources MultiCheckbox to use `leadSourceOptions`:

   Replace `options={isHS ? HS_LEAD_SOURCES : RE_LEAD_SOURCES}` with:
   ```tsx
   options={leadSourceOptions}
   ```

4. All other fields in Step 3 (response speed, lead tracking, conversion rate, missed call handling, etc.) remain unchanged — they use the same options regardless of sub-niche.
  </action>
  <verify>
- `npm run build` succeeds
- With HVAC selected, Step 3 lead sources show "Emergency Call-Ins", "Home Warranty Company Referrals"
- With Pest Control selected, Step 3 lead sources show "HOA Partnerships", "Seasonal Campaigns"
- With Construction selected, Step 3 lead sources show "Architect/Engineer Partnerships", "Builder/Developer Referrals"
- With Commercial RE selected, Step 3 lead sources show "CoStar/LoopNet Leads", "LinkedIn Outreach"
- All other Step 3 fields (response speed, lead tracking, etc.) are unchanged
  </verify>
  <done>Step 3 wired to sub-niche config for lead source options. Users see trade-specific lead channels. All other Step 3 fields remain unchanged.</done>
</task>

<task type="auto">
  <name>Task 4: Wire Step 7 (Operations) to sub-niche config</name>
  <files>
    src/components/audit/Step7Operations.tsx
  </files>
  <action>
1. Add import:
   ```typescript
   import { getSubNicheOptions } from "@/config/subNicheConfig";
   ```

2. Inside the component, add sub-niche option resolution:

   ```typescript
   // Sub-niche-aware KPI options
   const subNicheOpts = state.subNiche ? getSubNicheOptions(state.subNiche) : null;

   const kpiOptions = subNicheOpts && subNicheOpts.kpis.length > 0
     ? toOptions(subNicheOpts.kpis)
     : (isHS ? HS_KPIS : RE_KPIS);
   ```

3. Update the KPI MultiCheckbox to use `kpiOptions`:

   Replace `options={isHS ? HS_KPIS : RE_KPIS}` with:
   ```tsx
   options={kpiOptions}
   ```

4. All other fields in Step 7 (performance measurement, job costing, inventory management, etc.) remain unchanged — they are niche-level, not sub-niche-level.

5. **Scoring compatibility check**: The `scoreKPIs()` function in `scoring.ts` counts selected KPIs and checks for "don't track" variant via `.includes("don't track")`. The new KPI options include "We don't track any KPIs" which contains "don't track", so the existing scoring logic works without modification.
  </action>
  <verify>
- `npm run build` succeeds
- With HVAC selected, Step 7 KPIs show "First-Time Fix Rate", "Emergency Call Response Time"
- With Pest Control selected, Step 7 KPIs show "Service Agreement Retention Rate", "Monthly Recurring Revenue (MRR)"
- With Property Management selected, Step 7 KPIs show "Occupancy Rate", "Rent Collection Rate"
- All KPI lists end with "We don't track any KPIs"
- All other Step 7 fields (performance measurement, job costing, etc.) are unchanged
- Scoring engine still works correctly (scoreKPIs counts selections and detects "don't track")
  </verify>
  <done>Step 7 wired to sub-niche config for KPI options. Users see trade-specific metrics. Scoring compatibility verified — scoreKPIs() works with new option values.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run test` passes
3. End-to-end flow test (dev server):
   a. Select Home Services -> HVAC -> fill Step 1 -> Step 2 shows ServiceTitan in CRM list
   b. Go back to Step 1, change to Pest Control -> Step 2 shows GorillaDesk in CRM list
   c. Step 3 shows different lead sources for HVAC vs Pest Control vs Roofing
   d. Step 7 shows different KPIs for each sub-niche group
4. RE flow test:
   a. Select Real Estate -> Commercial -> Step 2 shows Apto, Buildout in CRM list
   b. Step 3 shows "CoStar/LoopNet Leads" in lead sources
   c. Step 7 shows "Total Square Footage Leased" in KPIs
5. No sub-niche fallback: without subNiche in state (shouldn't happen after validation), base options display
6. Previously selected values that no longer appear in the new option list: existing selected values in form state remain (user can clear/change on revisit). No automatic clearing needed — the values are in state but may not match new dropdown options. This is acceptable UX.
</verification>

<success_criteria>
- Steps 2, 3, and 7 dynamically adapt option lists based on selected sub-niche
- CRM and lead source lists are fully replaced by sub-niche-specific lists
- Tools checklist is extended (not replaced) by sub-niche extras
- KPI lists are fully replaced by sub-niche-specific lists
- Fallback to base niche options when no sub-niche is selected
- Scoring engine works with all new option values
- No regressions in Steps 4, 5, 6, 8 (untouched by this plan)
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-sub-niche-config-and-selection-ui/08-04-SUMMARY.md`
</output>
