---
phase: 08-sub-niche-config-and-selection-ui
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/components/audit/SubNicheSelector.tsx
  - src/components/audit/Step1BusinessInfo.tsx
  - src/pages/AuditForm.tsx
  - public/locales/en/steps.json
  - public/locales/en/common.json
autonomous: true
requirements:
  - SUBN-01
  - SUBN-02
  - SUBN-08

must_haves:
  truths:
    - "SubNicheSelector renders a card grid of sub-niches filtered by the current niche"
    - "Selecting Home Services shows 12 sub-niche cards; selecting Real Estate shows 5 sub-niche cards"
    - "Each card displays the sub-niche emoji and label"
    - "Clicking a card dispatches SET_SUB_NICHE and visually highlights the selected card"
    - "Sub-niche selection is required — user cannot advance from Step 1 to Step 2 without selecting a sub-niche"
    - "Sub-niche selection persists in localStorage via existing auto-save mechanism"
    - "The SubNicheSelector appears within Step 1 below the niche-specific business info fields, sequentially revealed after niche selection"
    - "npm run build succeeds with zero errors"
  artifacts:
    - path: "src/components/audit/SubNicheSelector.tsx"
      provides: "Card grid component for sub-niche selection"
      contains: "SubNicheSelector"
    - path: "src/components/audit/Step1BusinessInfo.tsx"
      provides: "Step 1 with integrated SubNicheSelector"
      contains: "SubNicheSelector"
    - path: "src/pages/AuditForm.tsx"
      provides: "Validation requiring sub-niche selection before advancing from Step 1"
      contains: "subNiche"
  key_links:
    - from: "src/components/audit/SubNicheSelector.tsx"
      to: "src/config/subNicheConfig.ts"
      via: "getSubNichesForNiche"
      pattern: "getSubNichesForNiche"
    - from: "src/pages/AuditForm.tsx"
      to: "src/types/audit.ts"
      via: "subNiche validation"
      pattern: "subNiche"
---

<objective>
Build the SubNicheSelector card grid component and integrate it into Step 1. Add validation in AuditForm.tsx requiring sub-niche selection before proceeding to Step 2. Add i18n keys for sub-niche labels and the selector header text.

Purpose: This is the user-facing UI plan for sub-niche selection — the gateway that gates all sub-niche-specific form branching in later steps. Users must select their specific trade or market segment before proceeding.
Output: A working card grid in Step 1 that captures sub-niche selection, validates it, and persists it in state/localStorage.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-sub-niche-config-and-selection-ui/08-CONTEXT.md
@src/types/audit.ts
@src/config/subNicheConfig.ts
@src/components/audit/Step1BusinessInfo.tsx
@src/components/audit/AuditFormComponents.tsx
@src/pages/AuditForm.tsx
@public/locales/en/steps.json
@public/locales/en/common.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SubNicheSelector component</name>
  <files>
    src/components/audit/SubNicheSelector.tsx
  </files>
  <action>
1. Create `src/components/audit/SubNicheSelector.tsx`:

   ```typescript
   import { SubNiche } from "@/types/audit";
   import { getSubNichesForNiche, SubNicheInfo } from "@/config/subNicheConfig";

   interface SubNicheSelectorProps {
     niche: "home_services" | "real_estate";
     selected: SubNiche | null;
     onSelect: (subNiche: SubNiche) => void;
     title: string;
   }

   export function SubNicheSelector({ niche, selected, onSelect, title }: SubNicheSelectorProps) {
     const subNiches = getSubNichesForNiche(niche);

     return (
       <div className="space-y-4">
         <h3 className="text-sm font-bold text-muted-foreground uppercase tracking-wider">
           {title}
         </h3>
         <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
           {subNiches.map((sn: SubNicheInfo) => {
             const isSelected = selected === sn.id;
             return (
               <button
                 key={sn.id}
                 type="button"
                 onClick={() => onSelect(sn.id)}
                 className={`flex flex-col items-center gap-2 px-3 py-4 rounded-xl border-2 transition-all text-sm font-medium ${
                   isSelected
                     ? "border-[hsl(var(--coral))] bg-[hsl(var(--coral)_/_0.05)] shadow-sm"
                     : "border-border bg-background hover:border-[hsl(var(--coral)_/_0.5)] hover:bg-secondary/50"
                 }`}
               >
                 <span className="text-2xl">{sn.emoji}</span>
                 <span className={isSelected ? "text-foreground font-semibold" : "text-foreground"}>
                   {sn.label}
                 </span>
               </button>
             );
           })}
         </div>
       </div>
     );
   }
   ```

   Design notes:
   - Compact card grid: 4 columns on desktop, 3 on small screens, 2 on mobile
   - Cards show emoji + label, no descriptions (12 HS cards need to be compact)
   - Selected state uses coral border + subtle background tint (consistent with existing MultiCheckbox selection style)
   - Uses `sn.label` directly (English) — Phase 11 will add `t(sn.labelKey)` for Bulgarian support
   - The `title` prop is passed in from Step 1 using a t() call so it's i18n-ready
  </action>
  <verify>
- `npm run build` succeeds
- Component exports `SubNicheSelector`
- Component accepts niche, selected, onSelect, and title props
- Renders correct number of cards (12 for HS, 5 for RE)
  </verify>
  <done>SubNicheSelector card grid component created with compact 4-column layout, emoji + label cards, and coral-themed selection highlighting.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate SubNicheSelector into Step 1 and add validation</name>
  <files>
    src/components/audit/Step1BusinessInfo.tsx
    src/pages/AuditForm.tsx
    src/components/audit/AuditFormComponents.tsx
    public/locales/en/steps.json
    public/locales/en/common.json
  </files>
  <action>
1. **Update `Step1BusinessInfo.tsx`** to include SubNicheSelector:

   - Add import: `import { SubNicheSelector } from "./SubNicheSelector";`
   - Add import: `import { SubNiche } from "@/types/audit";`

   - The `StepProps` interface currently has `state`, `dispatch`, `isHS`. The component already has access to `state.niche` and `dispatch`. No prop changes needed.

   - At the bottom of the Step 1 form (after the niche-specific business info section, before the closing `</div>`), add the SubNicheSelector section:

   ```tsx
   {/* Sub-Niche Selection */}
   <div className="border-t border-border pt-5">
     <SubNicheSelector
       niche={state.niche!}
       selected={state.subNiche}
       onSelect={(subNiche: SubNiche) => dispatch({ type: "SET_SUB_NICHE", payload: subNiche })}
       title={isHS ? t('step1.hs.subNiche.title') : t('step1.re.subNiche.title')}
     />
   </div>
   ```

   This section renders after the niche-specific fields (industry, employee count, etc.) so the user sees it as a natural continuation of "tell us about your business."

2. **Update `AuditForm.tsx` `validateStep()` function** to require sub-niche selection on Step 1:

   In the `case 1:` block, add after the existing email validation:
   ```typescript
   if (!state.subNiche) errors.push(t('validation.subNicheRequired'));
   ```

   Also add the HS-specific industry requirement:
   ```typescript
   if (state.niche === "home_services" && !state.step1.industry)
     errors.push(t('validation.industryRequired'));
   ```

   (The `industry` field was already `required` in the form UI but not validated in `validateStep()`. Add validation now since it's part of Step 1.)

3. **Add i18n keys to `public/locales/en/steps.json`** — add to the existing `step1` object:

   ```json
   "step1": {
     ... existing keys ...,
     "hs": {
       ... existing hs keys ...,
       "subNiche": {
         "title": "What type of trade business do you run?"
       }
     },
     "re": {
       ... existing re keys ...,
       "subNiche": {
         "title": "What's your primary market segment?"
       }
     }
   }
   ```

4. **Add validation message to `public/locales/en/common.json`**:

   ```json
   "validation": {
     ... existing keys ...,
     "subNicheRequired": "Please select your specific business type",
     "industryRequired": "Please select your industry"
   }
   ```

5. **Update `StepProps` in `AuditFormComponents.tsx`** — no changes needed. The `StepProps` interface already has `state` which includes `subNiche` after 08-01. `dispatch` already accepts `SET_SUB_NICHE` after 08-01.
  </action>
  <verify>
- `npm run build` succeeds
- Step 1 shows SubNicheSelector after the niche-specific fields
- HS niche shows 12 sub-niche cards
- RE niche shows 5 sub-niche cards
- Clicking a card dispatches SET_SUB_NICHE (state updates, card highlights)
- Attempting to advance without sub-niche selection shows validation error "Please select your specific business type"
- Refreshing the page after selecting a sub-niche restores the selection (localStorage persistence)
- Sub-niche selection works the same regardless of language (en or bg URL)
  </verify>
  <done>SubNicheSelector integrated into Step 1 below niche-specific fields. Validation requires sub-niche selection before advancing to Step 2. i18n keys added for selector titles and validation messages. Selection persists via existing localStorage auto-save.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run test` passes
3. `npm run dev` — navigate to `/audit?niche=home_services`:
   - Step 1 shows the business info fields followed by a sub-niche card grid with 12 options
   - Clicking "HVAC" highlights it with coral border
   - Attempting to click Next without selecting a sub-niche shows validation error
   - After selecting HVAC + filling required fields, Next advances to Step 2
4. Navigate to `/audit?niche=real_estate`:
   - Step 1 shows 5 real estate sub-niche cards
   - Selecting "Residential Sales" highlights it
5. Refresh the page — sub-niche selection is preserved
6. The sub-niche cards display correctly on mobile (2 columns), tablet (3 columns), and desktop (4 columns)
</verification>

<success_criteria>
- SubNicheSelector component renders a responsive card grid of sub-niches
- Cards show emoji + label with clear selected state
- Sub-niche selection is required to advance from Step 1 (validation error)
- Selection persists in localStorage and survives page refresh
- No regressions in existing Step 1 functionality (business name, email, industry, etc.)
- i18n keys added for selector titles and validation messages
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-sub-niche-config-and-selection-ui/08-02-SUMMARY.md`
</output>
