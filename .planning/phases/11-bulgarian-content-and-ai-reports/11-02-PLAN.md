---
phase: 11-bulgarian-content-and-ai-reports
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/subNicheConfig.ts
  - src/components/audit/Step1BusinessInfo.tsx
  - src/components/audit/Step2Technology.tsx
  - src/components/audit/Step3LeadFunnel.tsx
  - src/components/audit/Step7Operations.tsx
autonomous: true
requirements: [TRANS-04, TRANS-05]

must_haves:
  truths:
    - "Bulgarian user sees EUR-denominated revenue tiers in Step 1 (e.g., 'Под 25 000 €') instead of USD tiers"
    - "Bulgarian user sees Bulgarian-market platforms in lead sources (imot.bg, homes.bg, OLX.bg, bazar.bg)"
    - "Bulgarian user sees Viber in communication tools alongside WhatsApp"
    - "English user continues to see the original US-market options unchanged"
    - "Form values stored in state are stable scoring keys — translated labels do not break scoring"
  artifacts:
    - path: "src/config/subNicheConfig.ts"
      provides: "Bulgarian market option overrides per sub-niche group with language-conditional resolution"
      contains: "BG_SUB_NICHE_OPTIONS"
    - path: "src/components/audit/Step1BusinessInfo.tsx"
      provides: "Language-conditional revenue/GCI option arrays (USD for EN, EUR for BG)"
      contains: "BG_HS_REVENUES"
    - path: "src/components/audit/Step2Technology.tsx"
      provides: "Language-aware CRM and tools options"
      contains: "lang"
    - path: "src/components/audit/Step3LeadFunnel.tsx"
      provides: "Language-aware lead source options with Bulgarian platforms"
      contains: "lang"
  key_links:
    - from: "src/components/audit/Step1BusinessInfo.tsx"
      to: "src/lib/scoring.ts"
      via: "Revenue/GCI values are NOT in scoring lookup tables — safe to use different EUR strings for BG"
      pattern: "annualRevenue|annualGCI"
    - from: "src/components/audit/Step2Technology.tsx"
      to: "src/config/subNicheConfig.ts"
      via: "getSubNicheOptions() returns sub-niche-specific options; language layer adds BG market options"
      pattern: "getSubNicheOptions"
    - from: "src/components/audit/Step3LeadFunnel.tsx"
      to: "src/config/subNicheConfig.ts"
      via: "leadSources from getSubNicheOptions(), language layer adds BG platforms"
      pattern: "getSubNicheOptions"
---

<objective>
Add Bulgarian-market form options and EUR-denominated pricing tiers so that Bulgarian users see locally relevant platforms, tools, and revenue ranges throughout the audit form.

Purpose: Without market-specific options, Bulgarian users would see US-centric tools (ServiceTitan, Zillow), USD pricing ($250K-$500K), and miss key local platforms (imot.bg, OLX.bg, Viber). This plan implements the "shared base + local additions" framework from CONTEXT.md.

Output: Language-aware option resolution in Step1-3 and Step7, with Bulgarian-market platforms and EUR revenue tiers.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-bulgarian-content-and-ai-reports/11-CONTEXT.md
@.planning/phases/11-bulgarian-content-and-ai-reports/11-RESEARCH.md

# Source files
@src/config/subNicheConfig.ts
@src/components/audit/Step1BusinessInfo.tsx
@src/components/audit/Step2Technology.tsx
@src/components/audit/Step3LeadFunnel.tsx
@src/components/audit/Step7Operations.tsx
@src/components/audit/AuditFormComponents.tsx
@src/hooks/useLang.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Bulgarian market options to subNicheConfig and EUR revenue tiers to Step1</name>
  <files>src/config/subNicheConfig.ts, src/components/audit/Step1BusinessInfo.tsx</files>
  <action>
**Part A: subNicheConfig.ts — Bulgarian market option overrides**

Add a parallel `BG_SUB_NICHE_OPTIONS` config map (same shape as `SUB_NICHE_OPTIONS`) with Bulgarian-market-specific options. The "shared base + local additions" framework means: keep widely-used international tools, ADD Bulgarian platforms, REMOVE US-only platforms.

Export a function `getSubNicheOptionsForLang(subNiche: SubNiche, lang: string): SubNicheOptions` that returns:
- `lang === 'bg'` -> BG_SUB_NICHE_OPTIONS (with Bulgarian-market platforms)
- else -> SUB_NICHE_OPTIONS (existing English/US options)

**Bulgarian market option specifics (from research):**

CRM options (shared across languages since Bulgarian businesses use international CRMs):
- HS reactive: Same international tools (ServiceTitan not available in BG, but keep for global relevance). Add: "Без CRM / софтуер" as Bulgarian for "No CRM/Software" — wait, values must stay English for scoring. Keep values identical, this is just about which CRMs appear in the list.
- Actually, CRM names are platform names (same in both languages). The key difference is: Bulgarian HS businesses rarely use ServiceTitan/FieldEdge (US-specific). For BG HS, replace with: "Jobber", "Housecall Pro", "ServiceM8", "Google Sheets/Excel", "Без CRM", "Друг" — BUT values must remain English scoring keys. Since CRM scoring counts array selection not specific values, platform names like "Jobber" are fine as both value and label.
- For BG CRM lists: Keep international tools that work globally, remove US-only. Add "Google Sheets/Excel" and "Без CRM" (but value = "No CRM/Software" for consistency).

Actually, per research: "Bulgarian trade businesses primarily use international CRM/software tools... spreadsheets/no CRM for smaller ones. No Bulgarian-specific field service management software."

**Simplified approach:** For BG, the CRM lists stay largely the same (they're international tools). The main differences are in lead sources and tools. Focus on:

1. **Lead sources** — the key differentiator:
   - BG HS reactive: "Google Търсене/SEO", "Google Ads", "Facebook/Instagram реклами", "OLX.bg", "bazar.bg", "Alo.bg", "Viber групи", "Препоръки от клиенти" (Word of Mouth)
   - BG HS recurring: Similar with "HOA" replaced by "Етажна собственост" partnerships
   - BG HS project_based: Replace "Houzz" with "OLX.bg", add "Facebook групи"
   - BG RE residential_sales: Replace "Zillow/Realtor.com" with "imot.bg", "imoti.net", "homes.bg", "address.bg"; add "OLX.bg"
   - BG RE commercial: Replace "CoStar/LoopNet" with "imot.bg Бизнес", "OLX.bg"
   - BG RE property_management: Replace "Zillow Rental Manager", "Apartments.com" with "imot.bg Наеми", "OLX.bg"
   - BG RE new_construction: Replace "Model Home Walk-Ins" with "Имотни изложения" (property exhibitions)
   - BG RE luxury_resort: Replace "International Property Portals" with "imot.bg Луксозни", "homes.bg"

   IMPORTANT on values: Lead source values flow to formState and AI context. They're used in scoring only by array length (count of lead sources), not by specific string. So BG-specific lead source values like "imot.bg" are safe — they won't break scoring. The values also appear in the AI prompt formContext, which is desirable (AI sees Bulgarian platforms).

2. **Tools extra** — add Viber:
   - For all BG groups, add "Viber" to toolsExtra (as it's the #1 messaging app in Bulgaria)

3. **KPIs** — mostly keep as-is since KPI names are business terms. The values are scoring-relevant (tracked KPI count matters). Keep English values for scoring consistency but this is handled at the label layer in translation files.

**Part B: Step1BusinessInfo.tsx — EUR revenue/GCI tiers**

Add language-conditional revenue and GCI option arrays for Bulgarian users. Use `useLang()` hook to get `lang`.

```typescript
// Bulgarian EUR-denominated tiers (from research)
const BG_HS_REVENUES = toOptions([
  "Под 25 000 €", "25 000 - 50 000 €", "50 000 - 100 000 €",
  "100 000 - 250 000 €", "250 000 - 500 000 €", "Над 500 000 €",
]);
const BG_RE_GCI = toOptions([
  "Под 15 000 €", "15 000 - 30 000 €", "30 000 - 60 000 €",
  "60 000 - 150 000 €", "Над 150 000 €",
]);
```

In the component, select options by language:
```typescript
const { lang } = useLang();
const revenueOptions = lang === 'bg' ? BG_HS_REVENUES : HS_REVENUES;
const gciOptions = lang === 'bg' ? BG_RE_GCI : RE_GCI;
```

Revenue/GCI values are NOT in scoring lookup tables (confirmed in research). They flow to AI prompt context and report hero display. EUR values are correct for Bulgarian users.

Also add BG-specific employee count labels, years in business, service area, team sizes — these use `toOptions()` where value === label, and they're not in scoring maps. For BG:
- Employee counts: same numbers, just different formatting is fine as-is
- Years: same — "Less than 1" etc. These ARE shown in Bulgarian via i18n already since we translate step1.hs.yearsInBusiness.label. But the option VALUES themselves appear as-is. Since these go to formContext for AI, English values are actually fine (AI understands them). Leave these unchanged — only revenue/GCI needs EUR tiers.

**Key constraint:** Revenue and GCI are the ONLY fields that need different value strings for BG. All other fields (CRM, employee count, years, response speed, etc.) keep English values and get Bulgarian display labels via the translation file (bg/steps.json handles the field labels/hints, while option values remain English for scoring).

Wait — dropdown answer options (response speed, lead tracking, etc.) have values that are exact English strings used in scoring lookup tables. These MUST keep English values. Their labels are translated via bg/steps.json. But currently `toOptions()` sets value === label. For these translated dropdowns to work, we need `{value: englishKey, label: bulgarianLabel}` pattern.

This is a bigger concern. Let me check: the Step components use `toOptions()` for dropdown answers like response speed. Example from Step3:
```typescript
const RESPONSE_SPEEDS_HS = toOptions(["Under 5 minutes", "5-30 minutes", ...]);
```

And in scoring.ts, these exact strings are keys in the scoring maps. If we translate the label, we need to NOT use `toOptions()` but instead provide `{value, label}` pairs.

However, this is handled by the Phase 7 pattern: field labels/hints come from i18n, but the OPTION VALUES in dropdowns remain English because `toOptions()` is used with English strings. The Bulgarian user sees translated field labels (from bg/steps.json) but the dropdown option text would be in English.

This means for dropdown options (response speed, lead tracking, etc.), we need to create translated option arrays with `{value: 'English scoring key', label: 'Bulgarian display'}` for Bulgarian users. This is a significant amount of work touching many step components.

**Revised approach:** Focus this task on:
1. Revenue/GCI EUR tiers (Step1) — different value strings, safe because not scored
2. Lead source Bulgarian market additions (via subNicheConfig) — value = platform name, safe because scored by count
3. CRM Bulgarian market adjustments (via subNicheConfig) — value = CRM name, safe because not scored by specific name
4. Tools extra with Viber (via subNicheConfig) — value = tool name, safe

For dropdown ANSWER options (response speed, scheduling method, lead tracking, etc.) that have scoring-keyed values: these need `{value: englishKey, label: bulgarianTranslation}` arrays. Add a helper function and translated option arrays.

Create a new helper in AuditFormComponents.tsx or a new utility:
```typescript
export function translatedOptions(
  items: Array<{ value: string; label: string }>,
): SelectOption[] {
  return items;
}
```

Actually, SelectOption already has `{value, label}`. The issue is creating the BG arrays. This is best done as a separate config file or inline in step components.

**For this task, scope to:**
1. EUR revenue/GCI tiers in Step1 (language-conditional)
2. BG market lead sources, CRMs, and tools in subNicheConfig.ts (new `BG_SUB_NICHE_OPTIONS` + `getSubNicheOptionsForLang()`)
3. Wire Step2 and Step3 to use `getSubNicheOptionsForLang(subNiche, lang)` instead of `getSubNicheOptions(subNiche)`

Leave dropdown ANSWER option translation (response speed, lead tracking, scheduling method, etc.) to the translation file labels — the dropdown shows English option text with Bulgarian field labels. This is acceptable for v1.1 launch and matches the Phase 7 decision: "Option arrays (toOptions) intentionally untranslated — values are scoring keys."
  </action>
  <verify>
Run `npm run build` to verify no TypeScript errors. Verify that `getSubNicheOptionsForLang` is exported and callable. Check that Step1 renders different revenue options for 'bg' vs 'en'.
  </verify>
  <done>
- subNicheConfig.ts exports `BG_SUB_NICHE_OPTIONS` and `getSubNicheOptionsForLang(subNiche, lang)`
- BG lead sources include imot.bg, homes.bg, OLX.bg, bazar.bg for relevant sub-niches
- BG tools include Viber for all sub-niche groups
- Step1 shows EUR revenue tiers for Bulgarian users, USD for English
- Step2 and Step3 use language-aware option resolution
- Build passes with no TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Step2, Step3, and Step7 to use language-aware sub-niche options</name>
  <files>src/components/audit/Step2Technology.tsx, src/components/audit/Step3LeadFunnel.tsx, src/components/audit/Step7Operations.tsx</files>
  <action>
Update Step2, Step3, and Step7 to use the new `getSubNicheOptionsForLang(subNiche, lang)` function instead of `getSubNicheOptions(subNiche)`.

In each component:
1. Import `useLang` from `@/hooks/useLang`
2. Get `lang` from `useLang()`
3. Replace `getSubNicheOptions(state.subNiche)` with `getSubNicheOptionsForLang(state.subNiche, lang)`
4. Replace the import of `getSubNicheOptions` with `getSubNicheOptionsForLang`

**Step2Technology.tsx:**
```typescript
import { useLang } from "@/hooks/useLang";
import { getSubNicheOptionsForLang } from "@/config/subNicheConfig";
// ...
const { lang } = useLang();
const subNicheOpts = state.subNiche ? getSubNicheOptionsForLang(state.subNiche, lang) : null;
```

**Step3LeadFunnel.tsx:**
Same pattern — replace `getSubNicheOptions` with `getSubNicheOptionsForLang`, add `useLang`.

**Step7Operations.tsx:**
Same pattern for KPI options.

Also add the base (non-sub-niche) lead source lists for Bulgarian. When no sub-niche is selected (shouldn't happen since sub-niche is required, but defensive), the base lists are used. For BG, create BG-specific base lists that include Bulgarian platforms:
- BG base HS lead sources: Include OLX.bg, bazar.bg, Facebook Marketplace/Groups, Google Search/SEO, Google Ads, Word of Mouth, Viber groups
- BG base RE lead sources: Include imot.bg, imoti.net, homes.bg, OLX.bg, Facebook, Google

These base lists are fallbacks. Add language-conditional base list selection in Step3:
```typescript
const leadSourceOptions = subNicheOpts && subNicheOpts.leadSources.length > 0
  ? toOptions(subNicheOpts.leadSources)
  : (isHS ? (lang === 'bg' ? BG_HS_LEAD_SOURCES : HS_LEAD_SOURCES) : (lang === 'bg' ? BG_RE_LEAD_SOURCES : RE_LEAD_SOURCES));
```

Define BG base lead source arrays in Step3 alongside the existing EN ones.
  </action>
  <verify>
Run `npm run build` to verify no TypeScript errors. Verify `getSubNicheOptionsForLang` is used in all 3 step components. Confirm no references to the old `getSubNicheOptions` remain in step components (it can still exist in subNicheConfig.ts for backward compatibility).
  </verify>
  <done>
- Step2, Step3, Step7 use `getSubNicheOptionsForLang(subNiche, lang)` for language-aware option resolution
- Bulgarian users see Bulgarian-market platforms in lead sources and tools
- English users see the original US-market options unchanged
- Build passes
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. Step1 renders EUR revenue tiers when lang === 'bg', USD when lang === 'en'
3. Step2 CRM options include appropriate tools for BG market when lang === 'bg'
4. Step3 lead sources include imot.bg, OLX.bg for BG real estate sub-niches
5. Step7 KPI options resolve correctly per language
6. English experience is identical to pre-Phase 11 (no regressions)
</verification>

<success_criteria>
- Bulgarian market options (imot.bg, homes.bg, OLX.bg, bazar.bg, Viber) appear for BG users
- EUR revenue/GCI tiers with Bulgarian formatting appear for BG users
- English users see unchanged US-market options
- Scoring is not affected (English values preserved where scoring depends on them)
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-bulgarian-content-and-ai-reports/11-02-SUMMARY.md`
</output>
