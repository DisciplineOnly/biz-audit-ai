---
phase: 02-ai-report-edge-function
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/_shared/cors.ts
  - supabase/functions/generate-report/index.ts
autonomous: true
requirements: [AI-01, AI-02, AI-03, AI-04, SEC-04]
user_setup:
  - service: anthropic
    why: "Claude Haiku 4.5 API key needed for AI report generation"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "https://console.anthropic.com → API Keys → Create Key"
    dashboard_config:
      - task: "Store ANTHROPIC_API_KEY as a Supabase project secret"
        location: "Supabase Dashboard → Project Settings → Edge Functions → Secrets → Add new secret (key: ANTHROPIC_API_KEY, value: sk-ant-...)"

must_haves:
  truths:
    - "report_status column exists on audits table with CHECK constraint for pending/completed/failed"
    - "generate-report edge function code exists with sanitization, prompt building, Claude API call, retry logic, and status updates"
    - "Free-text fields (businessName, techFrustrations, biggestChallenge) are sanitized before reaching the LLM prompt"
    - "PII (email, phone, contactName) is excluded from the LLM prompt"
    - "AI prompt includes niche context and category scores sorted by weakness"
    - "AI output schema includes executiveSummary, gaps, quickWins, strategicRecommendations with priority and cta per item"
  artifacts:
    - path: "supabase/functions/_shared/cors.ts"
      provides: "Shared CORS headers for all edge functions"
      contains: "corsHeaders"
    - path: "supabase/functions/generate-report/index.ts"
      provides: "Complete edge function with Claude Haiku 4.5 integration"
      contains: "Deno.serve"
  key_links:
    - from: "supabase/functions/generate-report/index.ts"
      to: "Anthropic Claude API"
      via: "npm:@anthropic-ai/sdk messages.create()"
      pattern: "anthropic\\.messages\\.create"
    - from: "supabase/functions/generate-report/index.ts"
      to: "audits table report_status column"
      via: "supabaseAdmin.from('audits').update()"
      pattern: "update.*report_status"
    - from: "supabase/functions/generate-report/index.ts"
      to: "supabase/functions/_shared/cors.ts"
      via: "import corsHeaders"
      pattern: "from.*_shared/cors"
---

<objective>
Create the database migration for `report_status` tracking, the shared CORS module, and the complete `generate-report` edge function code with input sanitization, prompt engineering, Claude Haiku 4.5 integration, retry logic, and status column updates.

Purpose: This plan produces all the artifacts needed for the AI report edge function. The migration adds the status tracking column, and the edge function code implements the full pipeline from sanitized input to structured AI output.

Output: Migration applied to Supabase, `supabase/functions/_shared/cors.ts`, and `supabase/functions/generate-report/index.ts` ready for deployment.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ai-report-edge-function/02-CONTEXT.md
@.planning/phases/02-ai-report-edge-function/02-RESEARCH.md
@.planning/phases/01-schema-and-environment/01-01-SUMMARY.md
@src/types/audit.ts
@src/lib/scoring.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply report_status migration and create shared CORS module</name>
  <files>supabase/functions/_shared/cors.ts</files>
  <action>
1. **Apply the migration** via Supabase MCP `apply_migration`:
   - Name: `add_report_status_to_audits`
   - Project ID: `qyktrwpgfyvgdnexzcpr`
   - SQL:
     ```sql
     ALTER TABLE public.audits
       ADD COLUMN report_status TEXT NOT NULL DEFAULT 'pending'
         CHECK (report_status IN ('pending', 'completed', 'failed'));
     ```

2. **Verify the migration** via MCP `execute_sql`:
   ```sql
   SELECT column_name, data_type, column_default, is_nullable
   FROM information_schema.columns
   WHERE table_name = 'audits' AND column_name = 'report_status';
   ```
   Expected: column exists, type TEXT, default 'pending', NOT NULL.

3. **Create the shared CORS headers file** at `supabase/functions/_shared/cors.ts`:
   ```typescript
   export const corsHeaders = {
     'Access-Control-Allow-Origin': '*',
     'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
   }
   ```
   This is the standard Supabase CORS pattern used by all edge functions.
  </action>
  <verify>
  - MCP execute_sql confirms `report_status` column exists with correct type and default
  - File `supabase/functions/_shared/cors.ts` exists and exports `corsHeaders`
  </verify>
  <done>report_status column on audits table with CHECK constraint for pending/completed/failed; shared CORS module created</done>
</task>

<task type="auto">
  <name>Task 2: Write the generate-report edge function</name>
  <files>supabase/functions/generate-report/index.ts</files>
  <action>
Create `supabase/functions/generate-report/index.ts` with the following structure. This is the core implementation task.

**Imports:**
```typescript
import 'jsr:@supabase/functions-js/edge-runtime.d.ts'
import { corsHeaders } from '../_shared/cors.ts'
import Anthropic from 'npm:@anthropic-ai/sdk'
import { createClient } from 'npm:@supabase/supabase-js@2'
```

**Constants:**
- `MODEL = 'claude-haiku-4-5-20251001'` (locked decision: Claude Haiku 4.5, use dated snapshot for stability)
- `MAX_TOKENS = 2048` (sufficient for report output)

**Sanitization functions (SEC-04):**
Per locked decision: regex-based strip + truncate.

`sanitizeText(input: string | undefined, maxLen: number = 500): string`
- Return empty string if falsy input
- Strip HTML tags: `/<[^>]*>/g` → ''
- Strip special chars except common punctuation: `/[^\w\s.,!?'-]/g` → ' '
- Normalize whitespace: `/\s+/g` → ' '
- Trim and slice to maxLen

`sanitizeBusinessName(name: string | undefined): string`
- Return 'Your Business' if falsy
- Strip HTML tags
- Allow `&` and `'` common in business names: `/[^\w\s.,&'-]/g` → ' '
- Normalize whitespace, trim, slice to 100 chars

**Prompt building function:**
`buildPrompt({ niche, businessName, scores, formAnswers, techFrustrations, biggestChallenge })`

Returns `{ system: string, user: string }`.

**System message must include:**
- Role: "You are a business operations advisor generating a personalized audit report."
- Tone: warm but honest, encouraging with clear direction (locked decision)
- Constraint: "Never recommend third-party tools, software vendors, or specific products by name. Identify problems and their business impact, steering toward custom solutions and expert consultation." (locked decision)
- Benchmark style: "Reference industry benchmarks using phrases like 'Most successful teams in your space...' without hard numbers or competitor names." (locked decision)
- CTA requirement: "Each gap, quick win, and recommendation MUST include a `cta` field with a personalized call-to-action nudging the reader to book a consultation call. Examples: 'Let us automate your follow-up sequence — book a call', 'We can build a custom scheduling system for your team'." (locked decision)
- JSON output instruction: "Respond with ONLY valid JSON. Do not include markdown code fences, preamble, or explanation. The entire response must be parseable by JSON.parse()."
- Exact JSON schema with field names and types:
  ```
  {
    "executiveSummary": "string (2-4 sentences, personalized paragraph referencing business name, niche, and overall score)",
    "gaps": [{ "title": "string", "description": "string (2-3 sentences)", "impact": "string (one-liner)", "priority": "high|medium|low", "cta": "string" }],
    "quickWins": [{ "title": "string", "description": "string (actionable steps)", "timeframe": "string", "priority": "high|medium|low", "cta": "string" }],
    "strategicRecommendations": [{ "title": "string", "description": "string", "roi": "string", "priority": "high|medium|low", "cta": "string" }]
  }
  ```

**Score-driven item count logic (locked decision):**
Include in the system message:
- Overall score < 40: generate 4-5 gaps, 3 quick wins, 3 strategic recommendations
- Overall score 40-65: generate 3 gaps, 3 quick wins, 3 strategic recommendations
- Overall score > 65: generate 2 gaps, 2 quick wins, 2 strategic recommendations

**User message must include:**
- Niche: `home_services` or `real_estate` with a human-readable label ("Home Services Business" or "Real Estate Team") (AI-02)
- Business name (sanitized)
- Overall score and each category score sorted ascending (weakest first) with their niche-specific labels (AI-03). Category labels differ by niche — use the labels from the `categories` array (e.g., "Scheduling & Dispatch" for HS, "Lead Management" for RE).
- Sanitized free-text context: techFrustrations, biggestChallenge (truncated to 500 chars)
- Key form answers from each step that provide context (e.g., CRM name, lead sources, scheduling method). Extract these from the `formState` object — include the string values that are most actionable for advice. Do NOT include PII (email, phone, contactName).

**PII exclusion (locked decision):**
When extracting form data for the prompt, explicitly skip:
- `formState.step1.email`
- `formState.step1.phone`
- `formState.step1.contactName`
Only `formState.step1.businessName` (sanitized) is included.

**Main handler (Deno.serve):**
1. CORS preflight check (OPTIONS → 200 with corsHeaders)
2. Parse request body: `{ auditId, formState, scores }`
3. Create Anthropic client with `maxRetries: 1` (locked decision: retry once, SDK handles backoff)
4. Create Supabase admin client with service role key for status updates
5. Sanitize inputs (businessName, techFrustrations, biggestChallenge)
6. Build system + user prompts
7. Call `anthropic.messages.create()` with model, max_tokens, system, messages
8. Extract response text from `message.content[0]`
9. Parse JSON response with `JSON.parse(responseText)`
10. Update `report_status` to 'completed' via supabaseAdmin
11. Return `{ success: true, report: reportData }` with 200

**Error handling:**
- Wrap the entire try block
- In catch: attempt to update `report_status` to 'failed' (best-effort, don't throw if this fails)
- Return `{ success: false, error: error.message }` with 500
- Do NOT generate fallback content (locked decision)

**Important implementation notes:**
- Instantiate Anthropic client and Supabase admin client INSIDE `Deno.serve` handler (not at module top level) — the handler may be invoked multiple times in per_worker mode
- Use `Deno.env.get('ANTHROPIC_API_KEY')!` for the API key
- Use `Deno.env.get('SUPABASE_URL')!` and `Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!` for the admin client (auto-injected, no setup needed)
  </action>
  <verify>
  - File exists at `supabase/functions/generate-report/index.ts`
  - File imports from `../_shared/cors.ts`, `npm:@anthropic-ai/sdk`, `npm:@supabase/supabase-js@2`
  - Grep confirms: `sanitizeText` function exists, `sanitizeBusinessName` function exists
  - Grep confirms: no PII fields (`.email`, `.phone`, `.contactName`) appear in prompt-building code
  - Grep confirms: `report_status` is updated to both 'completed' and 'failed'
  - Grep confirms: `claude-haiku-4-5-20251001` model string present
  - Grep confirms: `maxRetries: 1` on Anthropic client
  - Grep confirms: JSON.parse() called on Claude response text
  </verify>
  <done>Complete generate-report edge function with: sanitization (SEC-04), niche-aware prompt (AI-02), score-aware prompt (AI-03), Claude Haiku 4.5 call (AI-01), structured JSON output matching report schema (AI-04), retry logic, and report_status tracking</done>
</task>

</tasks>

<verification>
1. `report_status` column exists on `audits` table with CHECK constraint — verify via MCP execute_sql
2. `supabase/functions/_shared/cors.ts` exports `corsHeaders` object
3. `supabase/functions/generate-report/index.ts` contains all required components:
   - Sanitization functions (sanitizeText, sanitizeBusinessName)
   - Prompt builder with niche context, category scores, no PII
   - Claude API call with model `claude-haiku-4-5-20251001` and `maxRetries: 1`
   - JSON parse of response
   - Status update to 'completed' on success, 'failed' on error
   - CORS preflight handler
4. No PII (email, phone, contactName) in prompt-building logic
</verification>

<success_criteria>
- report_status column exists and defaults to 'pending'
- Edge function code is complete and ready for deployment
- All five requirements (AI-01 through AI-04, SEC-04) are addressed in the code
</success_criteria>

<output>
After completion, create `.planning/phases/02-ai-report-edge-function/02-01-SUMMARY.md`
</output>
