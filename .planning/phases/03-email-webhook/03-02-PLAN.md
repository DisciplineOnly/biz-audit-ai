---
phase: 03-email-webhook
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - supabase/functions/send-notification/index.ts
autonomous: true
requirements: [EMAIL-01]

must_haves:
  truths:
    - "The send-notification edge function receives a webhook POST and sends an admin email via Resend"
    - "The admin email contains contact name, email, phone, niche, overall score, all category scores, top AI recommendations, and a report link"
    - "The function guards on report_status === 'completed' and returns 200 for all other updates"
    - "Email failures are caught and logged without returning 5xx (prevents webhook retries)"
    - "The email_status column is updated to 'sent' or 'failed' after the email attempt"
  artifacts:
    - path: "supabase/functions/send-notification/index.ts"
      provides: "Webhook receiver edge function with Resend email sending"
      min_lines: 100
      exports: []
  key_links:
    - from: "supabase/functions/send-notification/index.ts"
      to: "https://api.resend.com/emails"
      via: "fetch POST with Bearer RESEND_API_KEY"
      pattern: "api\\.resend\\.com/emails"
    - from: "supabase/functions/send-notification/index.ts"
      to: "audit_reports table"
      via: "supabaseAdmin.from('audit_reports').select()"
      pattern: "audit_reports.*select"
    - from: "supabase/functions/send-notification/index.ts"
      to: "audits table email_status"
      via: "supabaseAdmin.from('audits').update({ email_status })"
      pattern: "email_status.*sent|failed"

user_setup:
  - service: resend
    why: "Email delivery via Resend API"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard (https://resend.com/api-keys) -> Create API Key"
      - name: ADMIN_EMAIL
        source: "The email address that should receive admin notifications (must be the same email used to create the Resend account when using onboarding@resend.dev)"
---

<objective>
Build the send-notification Supabase edge function that receives Database Webhook POSTs, reads the AI report from audit_reports, sends an admin notification email via the Resend API, and updates email_status on the audits row.

Purpose: This is the core EMAIL-01 implementation. When generate-report completes and sets report_status to 'completed', a Database Webhook will POST to this function, which sends a rich admin email containing the audit summary and AI-generated recommendations.

Output: One new edge function file at supabase/functions/send-notification/index.ts.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-email-webhook/03-RESEARCH.md
@.planning/phases/03-email-webhook/03-01-SUMMARY.md
@supabase/functions/generate-report/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create send-notification edge function with admin email via Resend</name>
  <files>supabase/functions/send-notification/index.ts</files>
  <action>
Create supabase/functions/send-notification/index.ts following the generate-report edge function pattern.

**Structure overview:**
1. Imports and env vars
2. Deno.serve handler
3. Webhook payload parsing + report_status guard
4. Read AI report from audit_reports table
5. Build admin email HTML
6. Send via Resend fetch API
7. Update email_status
8. Always return 200

**Detailed implementation:**

**Imports:**
```typescript
import 'jsr:@supabase/functions-js/edge-runtime.d.ts'
import { createClient } from 'npm:@supabase/supabase-js@2'
```
No CORS import needed — this function is called by the Database Webhook (server-to-server), not from the browser.

**Handler:**
```typescript
Deno.serve(async (req: Request) => {
```
All clients and env reads INSIDE the handler (per_worker mode pattern from generate-report).

**Webhook payload parsing:**
The Database Webhook sends a JSON body with this structure:
```typescript
interface WebhookPayload {
  type: 'UPDATE'
  table: string
  schema: string
  record: {
    id: string
    contact_name: string
    contact_email: string
    contact_phone: string | null
    niche: string
    overall_score: number
    scores: Record<string, unknown>
    form_data: Record<string, unknown>
    report_status: string
    email_status: string
    created_at: string
  }
  old_record: Record<string, unknown>
}
```

**Guard (CRITICAL — first thing after parsing):**
```typescript
if (record.report_status !== 'completed') {
  return new Response(JSON.stringify({ skipped: true }), { status: 200 })
}
```
Per user decision: use 'completed' (not 'complete'). The webhook fires on ALL UPDATE events to the audits table. Only process completion events. Always return 200 to prevent retries.

**Also guard against re-processing:** If `record.email_status !== 'pending'`, return 200 early. This prevents duplicate emails if the webhook fires again (e.g., if another column is updated after email was already sent).

**Read AI report from audit_reports:**
```typescript
const supabaseAdmin = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!,
)

const { data: reportRow, error: reportError } = await supabaseAdmin
  .from('audit_reports')
  .select('report')
  .eq('audit_id', record.id)
  .single()
```
If no report found (reportError or !reportRow), log a warning and continue with email sending — the admin email can still include scores and contact info even without AI recommendations. Set a flag like `hasAiReport = false` to conditionally include the recommendations section.

**Build admin email HTML (buildAdminEmailHtml function):**

Create a function `buildAdminEmailHtml(record, aiReport)` that returns an HTML string.

The email must include (per locked decisions):
- Contact name, email, phone
- Niche (formatted: "Home Services" or "Real Estate")
- Overall score (with color: red <40, orange 40-59, yellow 60-74, green 75+)
- All 7 per-category scores (from record.scores JSONB)
- Top 2-3 AI-generated recommendations (from aiReport.strategicRecommendations if available)
- Report link: `https://bizaudit.epsystems.dev/report/${record.id}` (use the production URL pattern)

**HTML email rules (from research):**
- Inline styles ONLY (no <style> blocks — Gmail strips them)
- Table-based layout (no flexbox/grid — Outlook uses Word renderer)
- Max width 600px
- Clean minimal styling: Stripe/Linear transactional style per locked decision
- Font: system sans-serif stack
- Colors: neutral grays for body, colored badge for score

**Email structure:**
```
[Header] New Audit Submission
[Contact block] Name, Email, Phone, Niche
[Score badge] Overall: XX/100 (color-coded)
[Category scores table] 7 rows, category name + score
[AI Recommendations] Top 2-3 strategic recommendations (title + description) — only if AI report available
[CTA button] "View Full Report" linking to /report/:id
[Footer] Sent by BizAudit notification system
```

The category scores are stored in `record.scores` as a JSONB object. The `scores` field contains a `categories` array with objects like `{ category, label, score, weight }`. Parse this to render the category table. If parsing fails, skip the category section gracefully.

**Send email via Resend:**
```typescript
const RESEND_API_KEY = Deno.env.get('RESEND_API_KEY')!
const ADMIN_EMAIL = Deno.env.get('ADMIN_EMAIL')!

const nicheLabel = record.niche === 'home_services' ? 'Home Services' : 'Real Estate'

const res = await fetch('https://api.resend.com/emails', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${RESEND_API_KEY}`,
  },
  body: JSON.stringify({
    from: 'E&PSystems <onboarding@resend.dev>',
    to: [ADMIN_EMAIL],
    subject: `New Audit: ${record.contact_name} — ${nicheLabel} (${record.overall_score}/100)`,
    html: buildAdminEmailHtml(record, reportRow?.report ?? null),
  }),
})
```

**Error handling and email_status update:**
Wrap the email send in try/catch. On success, update email_status to 'sent'. On failure, log the error and update email_status to 'failed'. NEVER throw from the outer handler — always return 200.

```typescript
let emailStatus = 'failed'
try {
  // ... send email ...
  if (!res.ok) {
    const errorBody = await res.text()
    console.error('Resend API error:', res.status, errorBody)
  } else {
    emailStatus = 'sent'
  }
} catch (err) {
  console.error('Email send failed:', (err as Error).message)
}

// Update email_status (best-effort)
try {
  await supabaseAdmin
    .from('audits')
    .update({ email_status: emailStatus })
    .eq('id', record.id)
} catch (err) {
  console.error('email_status update failed:', (err as Error).message)
}

return new Response(JSON.stringify({ emailStatus }), { status: 200 })
```

The outermost try/catch wraps everything and also returns 200 with the error message. This prevents webhook retries on any unexpected failure.

**PII in logs:** Do NOT log the full record. Only log error messages. contact_email is PII — do not include in console.error calls.

**What NOT to build:**
- No user email (EMAIL-02 is deferred per user decision #1)
- No CORS headers (server-to-server only)
- No 'partial' email_status (simplified per user decision #4)
- No retry logic (best-effort per locked decision)
  </action>
  <verify>
1. Read the created file and confirm:
   - `Deno.serve` handler pattern matches generate-report
   - Guard checks `record.report_status !== 'completed'` (not 'complete')
   - Guard checks `record.email_status !== 'pending'` for duplicate prevention
   - Reads from `audit_reports` table
   - Sends to ADMIN_EMAIL only (no user email)
   - Uses `fetch('https://api.resend.com/emails', ...)` with Bearer token
   - From address is `E&PSystems <onboarding@resend.dev>`
   - Updates email_status to 'sent' or 'failed' (no 'partial')
   - Always returns Response with status 200
   - No console.error contains PII (contact_email)

2. Verify HTML email template:
   - Uses inline styles only (no `<style>` block)
   - Table-based layout
   - Contains contact info, scores, recommendations, report link
   - Score has color coding
  </verify>
  <done>send-notification edge function exists, receives webhook POST, guards on 'completed' status, reads AI report from audit_reports, sends rich admin email via Resend fetch API, updates email_status to sent/failed, and always returns 200. No user email is sent (EMAIL-02 deferred).</done>
</task>

</tasks>

<verification>
- supabase/functions/send-notification/index.ts exists and is >100 lines
- Function handles webhook payload parsing correctly
- Guard uses 'completed' (not 'complete')
- Only admin email is sent (no user email code)
- email_status values are 'sent' or 'failed' only (no 'partial')
- HTML uses inline styles and table layout
- All errors caught, 200 always returned
</verification>

<success_criteria>
- The send-notification edge function is complete and ready for deployment
- Admin email includes all required fields: contact name, email, phone, niche, overall score, category scores, AI recommendations, report link
- The function is resilient: missing AI report degrades gracefully, email failures log and continue, always returns 200
- No user email code exists (EMAIL-02 deferred)
</success_criteria>

<output>
After completion, create `.planning/phases/03-email-webhook/03-02-SUMMARY.md`
</output>
