---
phase: 06-i18n-infrastructure-and-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/i18n.ts
  - src/locales/bg/translation.json
  - src/locales/en/translation.json
  - src/@types/i18next.d.ts
  - src/main.tsx
  - src/App.tsx
  - src/components/LangLayout.tsx
  - src/hooks/useLang.ts
autonomous: true
requirements:
  - I18N-01
  - I18N-03

must_haves:
  truths:
    - "Visiting `/` loads the app with i18n.language === 'bg'"
    - "Visiting `/en/` loads the app with i18n.language === 'en'"
    - "Visiting `/en/audit` loads AuditForm with English active"
    - "Visiting `/bg/audit` loads AuditForm with Bulgarian active (same as `/audit`)"
    - "The useLang() hook returns prefix '' for Bulgarian and '/en' for English"
  artifacts:
    - path: "src/lib/i18n.ts"
      provides: "i18next initialization with URL-driven language detection"
      contains: "i18n.init"
    - path: "src/locales/bg/translation.json"
      provides: "Bulgarian translation namespace (minimal skeleton)"
    - path: "src/locales/en/translation.json"
      provides: "English translation namespace (minimal skeleton)"
    - path: "src/@types/i18next.d.ts"
      provides: "TypeScript type-safety for translation keys"
      contains: "CustomTypeOptions"
    - path: "src/components/LangLayout.tsx"
      provides: "Route layout that syncs i18n.language with URL param"
      exports: ["LangLayout"]
    - path: "src/hooks/useLang.ts"
      provides: "Language prefix hook for navigation"
      exports: ["useLang"]
    - path: "src/App.tsx"
      provides: "Route tree with /:lang? optional segment"
      contains: "/:lang?"
  key_links:
    - from: "src/main.tsx"
      to: "src/lib/i18n.ts"
      via: "import before App render"
      pattern: "import.*i18n"
    - from: "src/App.tsx"
      to: "src/components/LangLayout.tsx"
      via: "Route element"
      pattern: "<Route.*LangLayout"
    - from: "src/components/LangLayout.tsx"
      to: "src/lib/i18n.ts"
      via: "i18n.changeLanguage in useEffect"
      pattern: "i18n\\.changeLanguage"
---

<objective>
Install i18next, create URL-driven language detection, and restructure the route tree with `/:lang?` optional segment so Bulgarian is the default language and English is accessed via `/en/` prefix.

Purpose: This is the foundation plan — all subsequent Phase 6 plans depend on i18n being initialized and routes being language-aware.
Output: Working i18next config, minimal translation JSONs, LangLayout route wrapper, useLang() hook, restructured App.tsx routes.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-i18n-infrastructure-and-routing/06-CONTEXT.md
@.planning/phases/06-i18n-infrastructure-and-routing/06-RESEARCH.md
@src/App.tsx
@src/main.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install i18next and create translation infrastructure</name>
  <files>
    package.json
    src/lib/i18n.ts
    src/locales/bg/translation.json
    src/locales/en/translation.json
    src/@types/i18next.d.ts
    src/main.tsx
  </files>
  <action>
1. Install packages: `npm install i18next react-i18next` (do NOT install i18next-browser-languagedetector — URL detection is manual per user decision).

2. Create `src/locales/en/translation.json` — minimal skeleton with these keys:
   ```json
   {
     "nav": { "home": "Home", "language": "Language" },
     "landing": { "title": "Get Your Free AI Business Audit" },
     "common": { "next": "Next Step", "back": "Back", "save": "Save Progress" }
   }
   ```

3. Create `src/locales/bg/translation.json` — matching structure with Bulgarian:
   ```json
   {
     "nav": { "home": "Начало", "language": "Език" },
     "landing": { "title": "Вземете безплатен AI одит на бизнеса си" },
     "common": { "next": "Следваща стъпка", "back": "Назад", "save": "Запази напредъка" }
   }
   ```

4. Create `src/lib/i18n.ts`:
   - Import i18next and initReactI18next
   - Import both translation JSON files as static imports
   - Read `window.location.pathname.split('/')[1]` to determine initial language
   - If first segment is `'en'` → `initialLng = 'en'`, otherwise `'bg'` (Bulgarian is default per user decision)
   - Call `i18n.use(initReactI18next).init({ lng: initialLng, fallbackLng: 'bg', resources: { bg: { translation: bgTranslation }, en: { translation: enTranslation } }, interpolation: { escapeValue: false } })`
   - Export default i18n
   - Do NOT use i18next-browser-languagedetector — "URL is king" per user decision

5. Create `src/@types/i18next.d.ts`:
   ```typescript
   import 'i18next';
   import type translation from '../locales/en/translation.json';

   declare module 'i18next' {
     interface CustomTypeOptions {
       defaultNS: 'translation';
       resources: {
         translation: typeof translation;
       };
     }
   }
   ```

6. Update `src/main.tsx` — add `import './lib/i18n';` as the FIRST import (before App import) to ensure i18n initializes before React renders.
  </action>
  <verify>
- `npm run build` succeeds (TypeScript compiles with new types)
- `src/lib/i18n.ts` exists and exports i18n instance
- Both translation JSON files exist with matching key structure
- `src/@types/i18next.d.ts` exists
- `src/main.tsx` imports i18n before App
  </verify>
  <done>i18next is installed and initialized synchronously from URL path. Both language JSON files exist with minimal skeleton keys. TypeScript type declarations provide autocomplete for translation keys.</done>
</task>

<task type="auto">
  <name>Task 2: Create LangLayout, useLang hook, and restructure route tree</name>
  <files>
    src/components/LangLayout.tsx
    src/hooks/useLang.ts
    src/App.tsx
  </files>
  <action>
1. Create `src/hooks/useLang.ts`:
   ```typescript
   import { useParams } from 'react-router-dom';

   export type Lang = 'bg' | 'en';

   export function useLang(): { lang: Lang; prefix: string } {
     const { lang } = useParams<{ lang?: string }>();
     const activeLang: Lang = lang === 'en' ? 'en' : 'bg';
     const prefix = activeLang === 'en' ? '/en' : '';
     return { lang: activeLang, prefix };
   }
   ```
   - `undefined` (root `/`), `'bg'`, and any invalid segment all resolve to `'bg'`
   - Only `'en'` resolves to English
   - Prefix is `''` for Bulgarian (default), `'/en'` for English

2. Create `src/components/LangLayout.tsx`:
   - Import `useEffect` from React, `useParams` and `Outlet` from react-router-dom, and `i18n` from `@/lib/i18n`
   - Extract `params.lang` via `useParams<{ lang?: string }>()`
   - Compute `activeLang`: if `lang === 'en'` then `'en'`, else `'bg'`
   - In `useEffect` dependent on `[activeLang]`: call `i18n.changeLanguage(activeLang)` only if `i18n.language !== activeLang`
   - Also set `document.documentElement.lang = activeLang` for accessibility
   - Return `<Outlet />`
   - Do NOT redirect `/bg/` to `/` — both work as Bulgarian per user decision
   - Do NOT redirect invalid segments (treat them as Bulgarian default)

3. Update `src/App.tsx`:
   - Import `LangLayout` from `./components/LangLayout`
   - Wrap all existing routes under a single `<Route path="/:lang?" element={<LangLayout />}>` parent
   - Move `index`, `audit`, `generating`, and `report/:auditId` routes as children of the lang layout
   - Move the `*` catch-all route INSIDE the `/:lang?` layout so `/en/nonexistent` also gets the 404 with correct language context
   - Final route structure:
     ```jsx
     <Route path="/:lang?" element={<LangLayout />}>
       <Route index element={<Index />} />
       <Route path="audit" element={<AuditForm />} />
       <Route path="generating" element={<Loading />} />
       <Route path="report/:auditId" element={<Report />} />
       <Route path="*" element={<NotFound />} />
     </Route>
     ```
  </action>
  <verify>
- `npm run build` succeeds
- `src/hooks/useLang.ts` exports `useLang` and `Lang` type
- `src/components/LangLayout.tsx` exports `LangLayout`
- `src/App.tsx` contains `/:lang?` route wrapping all child routes
- Run `npm run dev` and confirm:
  - `/` loads the app (Bulgarian default)
  - `/en/` loads the app (English)
  - `/en/audit` loads AuditForm
  - `/audit` loads AuditForm
  - `/bg/` loads the app (Bulgarian alias)
  </verify>
  <done>Route tree uses `/:lang?` optional segment. LangLayout syncs i18n.language with URL on every navigation. useLang() hook provides `{ lang, prefix }` for downstream use by navigation and language toggle components.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run dev` — visit `/`, `/en/`, `/bg/`, `/en/audit`, `/audit` — all render correct pages
3. Check browser console: `i18next initialized with language 'bg'` on `/`, `'en'` on `/en/`
4. `document.documentElement.lang` attribute matches active language
</verification>

<success_criteria>
- i18next is installed and initialized synchronously from URL path before React renders
- Route tree uses `/:lang?` optional segment — no route duplication
- LangLayout component syncs i18n language on every URL change
- useLang() hook returns correct prefix for Bulgarian ('') and English ('/en')
- Both `/` and `/bg/` serve Bulgarian; `/en/` serves English
- TypeScript type-safety for translation keys via declaration file
</success_criteria>

<output>
After completion, create `.planning/phases/06-i18n-infrastructure-and-routing/06-01-SUMMARY.md`
</output>
