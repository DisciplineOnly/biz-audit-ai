---
phase: 06-i18n-infrastructure-and-routing
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - src/pages/Index.tsx
  - src/pages/AuditForm.tsx
  - src/pages/Loading.tsx
  - src/pages/Report.tsx
  - src/pages/NotFound.tsx
  - src/components/LanguageToggle.tsx
autonomous: true
requirements:
  - I18N-02
  - I18N-04
  - I18N-06

must_haves:
  truths:
    - "All navigate() calls prepend the language prefix — an English user never loses /en/ during navigation"
    - "All <Link to> elements include the language prefix"
    - "The language toggle on the landing page switches between /en/ and / (Bulgarian default)"
    - "The language toggle is visible on the landing page and Step 1 only — hidden on Steps 2-8 and all other pages"
    - "Navigating the full audit flow in English (/en/audit -> /en/generating -> /en/report/:id) preserves the /en/ prefix throughout"
    - "Shareable report URL at /en/report/:id opens in English"
  artifacts:
    - path: "src/pages/Index.tsx"
      provides: "Language-aware landing page with toggle integration"
      contains: "useLang"
    - path: "src/pages/AuditForm.tsx"
      provides: "Language-aware audit form with prefix on all navigations"
      contains: "useLang"
    - path: "src/pages/Loading.tsx"
      provides: "Language-aware loading page with prefix on report URL"
      contains: "useLang"
    - path: "src/pages/Report.tsx"
      provides: "Language-aware report page with prefix on all links"
      contains: "useLang"
    - path: "src/components/LanguageToggle.tsx"
      provides: "Language switcher widget (BG/EN toggle)"
      exports: ["LanguageToggle"]
  key_links:
    - from: "src/pages/Loading.tsx"
      to: "src/pages/Report.tsx"
      via: "navigate with prefix to /report/:id"
      pattern: "navigate.*prefix.*report"
    - from: "src/pages/Index.tsx"
      to: "src/pages/AuditForm.tsx"
      via: "navigate with prefix to /audit"
      pattern: "navigate.*prefix.*audit"
    - from: "src/components/LanguageToggle.tsx"
      to: "src/hooks/useLang.ts"
      via: "useLang for current language and prefix"
      pattern: "useLang"
    - from: "src/pages/AuditForm.tsx"
      to: "src/components/LanguageToggle.tsx"
      via: "conditionally renders toggle on Step 1 only"
      pattern: "LanguageToggle"
---

<objective>
Update all page-level navigation to preserve the language prefix and create the LanguageToggle widget for the landing page and Step 1.

Purpose: Without prefix-aware navigation, an English user clicking any link or being redirected loses their `/en/` prefix and sees Bulgarian. This plan closes that gap and adds the language switching UI per user decisions (visible on landing + Step 1 only).
Output: All pages use useLang() prefix in navigation; LanguageToggle component created and integrated.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-i18n-infrastructure-and-routing/06-CONTEXT.md
@.planning/phases/06-i18n-infrastructure-and-routing/06-RESEARCH.md
@.planning/phases/06-i18n-infrastructure-and-routing/06-01-SUMMARY.md
@src/pages/Index.tsx
@src/pages/AuditForm.tsx
@src/pages/Loading.tsx
@src/pages/Report.tsx
@src/pages/NotFound.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update all page navigate() and Link calls to use language prefix</name>
  <files>
    src/pages/Index.tsx
    src/pages/AuditForm.tsx
    src/pages/Loading.tsx
    src/pages/Report.tsx
    src/pages/NotFound.tsx
  </files>
  <action>
For every page file, import `useLang` from `@/hooks/useLang` and prepend `prefix` to all navigation targets.

**src/pages/Index.tsx** (~2 navigate calls):
- Add `const { prefix } = useLang();` inside the component
- `navigate(`/audit?niche=${niche}&resume=true`)` → `navigate(`${prefix}/audit?niche=${niche}&resume=true`)`
- `navigate(`/audit?niche=${niche}`)` → `navigate(`${prefix}/audit?niche=${niche}`)`

**src/pages/AuditForm.tsx** (~4 navigate calls):
- Add `const { prefix } = useLang();` inside the component
- `navigate("/")` → `navigate(prefix || "/")`
- `navigate("/generating", { state: ... })` → `navigate(`${prefix}/generating`, { state: ... })`
- Any other `navigate("/")` calls → `navigate(prefix || "/")`
- The `onClick={() => navigate("/")}` in the header back button → `onClick={() => navigate(prefix || "/")}`

**src/pages/Loading.tsx** (~5 navigate calls):
- Add `const { prefix } = useLang();` inside the component
- CRITICAL for I18N-06: `navigate(`/report/${auditId}`, ...)` → `navigate(`${prefix}/report/${auditId}`, ...)` — this is the shareable URL, language prefix must be included
- All `navigate("/")` error/timeout fallbacks → `navigate(prefix || "/")`
- There are 3 `navigate(`/report/${auditId}`, ...)` calls and 2 `navigate("/")` calls — update ALL of them

**src/pages/Report.tsx** (~3 Link/navigate calls):
- Add `const { prefix } = useLang();` inside the component
- `<Link to="/" ...>` → `<Link to={prefix || "/"} ...>`  (appears twice: header link and footer link)
- `navigate("/")` in the header button → `navigate(prefix || "/")`
- Check for any other bare path references

**src/pages/NotFound.tsx** (likely 1 Link):
- Add `const { prefix } = useLang();` inside the component
- Any `<Link to="/">` → `<Link to={prefix || "/"}>` — so English users stay on `/en/` when going home from 404

**CRITICAL anti-pattern:** Do NOT use `navigate(prefix + "/")` when prefix is `''` — that produces `navigate("/")` which works. But for clarity, use `navigate(prefix || "/")` for home navigation. For subpaths like `/audit`, use template literals: `navigate(`${prefix}/audit`)` — when prefix is `''`, this produces `navigate("/audit")` which is correct.
  </action>
  <verify>
- `npm run build` succeeds
- Grep for bare `navigate("/")` or `navigate(\`/` without `prefix` — should find ZERO remaining instances in page files
- Grep for `<Link to="/"` without `prefix` — should find ZERO remaining instances in page files
- Run `npm run dev`, navigate through `/en/audit` → `/en/generating` → `/en/report/:id` — URL stays `/en/` prefixed throughout
- Navigate through `/audit` → `/generating` → `/report/:id` — URL has no prefix (Bulgarian default)
  </verify>
  <done>Every navigate() and Link in all page files prepends the language prefix. English users never lose /en/ during the audit flow. Shareable report URLs include the language prefix.</done>
</task>

<task type="auto">
  <name>Task 2: Create LanguageToggle component and integrate into landing page and Step 1</name>
  <files>
    src/components/LanguageToggle.tsx
    src/pages/Index.tsx
    src/pages/AuditForm.tsx
  </files>
  <action>
1. Create `src/components/LanguageToggle.tsx`:
   - Import `useNavigate`, `useLocation` from react-router-dom
   - Import `useLang`, `Lang` from `@/hooks/useLang`
   - The component renders two buttons: "BG" and "EN" (or use flag emojis / text labels — Claude's discretion per user decision)
   - On click, compute the new URL:
     - Get current `location.pathname` and `location.search`
     - Strip the old prefix from pathname: if current `prefix` is not empty, remove it from the start of pathname
     - Prepend the new prefix: `newLang === 'en' ? '/en' : ''`
     - Navigate to `newPath + location.search`
   - Style the active language button as selected (use coral accent color consistent with app design)
   - The component should be compact — suitable for top-right corner of pages
   - Use Tailwind classes consistent with the app's design (rounded, border, coral accent for active)

   Example implementation:
   ```typescript
   export function LanguageToggle() {
     const navigate = useNavigate();
     const location = useLocation();
     const { lang, prefix } = useLang();

     const switchLang = (newLang: Lang) => {
       if (newLang === lang) return;
       const newPrefix = newLang === 'en' ? '/en' : '';
       const pathWithoutPrefix = prefix
         ? location.pathname.replace(new RegExp(`^${prefix}`), '') || '/'
         : location.pathname;
       navigate(newPrefix + pathWithoutPrefix + location.search);
     };

     return (
       <div className="flex items-center gap-1 rounded-lg border border-border p-1">
         <button
           onClick={() => switchLang('bg')}
           className={`px-3 py-1 rounded-md text-sm font-medium transition-all ${
             lang === 'bg'
               ? 'bg-[hsl(var(--coral))] text-white'
               : 'text-muted-foreground hover:text-foreground'
           }`}
         >
           BG
         </button>
         <button
           onClick={() => switchLang('en')}
           className={`px-3 py-1 rounded-md text-sm font-medium transition-all ${
             lang === 'en'
               ? 'bg-[hsl(var(--coral))] text-white'
               : 'text-muted-foreground hover:text-foreground'
           }`}
         >
           EN
         </button>
       </div>
     );
   }
   ```

2. Integrate into `src/pages/Index.tsx`:
   - Import `LanguageToggle` from `@/components/LanguageToggle`
   - Place the toggle in the top-right area of the landing page (exact placement is Claude's discretion — position it where it's visible but not intrusive, e.g., absolute top-right of the page container or in a header bar)

3. Integrate into `src/pages/AuditForm.tsx`:
   - Import `LanguageToggle` from `@/components/LanguageToggle`
   - Conditionally render: show the toggle ONLY when the current step is 1 (`currentStep === 1` or however the wizard tracks the step)
   - Per user decision: once the user advances past Step 1, the language widget is **hidden entirely** (not disabled — removed from the DOM)
   - Place it in the form header area near the step indicator or top-right of the form container

**User decision enforcement:**
- Toggle visible on landing page: YES
- Toggle visible on Step 1: YES
- Toggle visible on Steps 2-8: NO (hidden entirely)
- Toggle visible on Loading, Report, NotFound: NO
- No "Start Over" option — users who want to switch language after Step 1 navigate manually to `/en/` or `/`
  </action>
  <verify>
- `npm run build` succeeds
- `src/components/LanguageToggle.tsx` exists and exports `LanguageToggle`
- Run `npm run dev`:
  - Landing page shows BG/EN toggle
  - Clicking EN from `/` navigates to `/en/` — page shows English
  - Clicking BG from `/en/` navigates to `/` — page shows Bulgarian
  - Start audit, go to Step 1 — toggle visible
  - Advance to Step 2 — toggle is gone from the DOM
  - Toggle on `/en/audit?niche=home_services` switches to `/audit?niche=home_services` (preserves query params)
  </verify>
  <done>LanguageToggle component renders BG/EN switcher that updates the URL and triggers i18n.changeLanguage via LangLayout. Toggle is visible only on landing page and Step 1. Language switch preserves current path and query params. Users cannot switch language mid-audit (after Step 1).</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Full English flow: `/en/` → click Start → `/en/audit?niche=home_services` → complete Steps 1-8 → `/en/generating` → `/en/report/:id` — prefix preserved throughout
3. Full Bulgarian flow: `/` → click Start → `/audit?niche=home_services` → complete Steps 1-8 → `/generating` → `/report/:id` — no prefix throughout
4. Language toggle: visible on landing + Step 1, hidden on Steps 2+
5. Toggle preserves query params and path when switching languages
6. Shareable URL: `/en/report/abc123` opens in English
7. Grep confirms: zero remaining bare `navigate("/")` or `<Link to="/"` in page files
</verification>

<success_criteria>
- All ~15 navigation call sites across 5 page files use useLang() prefix
- LanguageToggle exists and switches between BG/EN by updating the URL
- Toggle is visible only on landing page and Step 1 (hidden on Steps 2-8 and other pages)
- Full audit flow preserves language prefix from start to finish
- Shareable report URLs include language context (I18N-06)
- English user never accidentally drops to Bulgarian during normal navigation
</success_criteria>

<output>
After completion, create `.planning/phases/06-i18n-infrastructure-and-routing/06-03-SUMMARY.md`
</output>
