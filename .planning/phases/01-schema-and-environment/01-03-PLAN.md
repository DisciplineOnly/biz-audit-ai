---
phase: 01-schema-and-environment
plan: 03
type: execute
wave: 2
depends_on:
  - 01-01
  - 01-02
files_modified: []
autonomous: false
requirements:
  - DATA-01
  - DATA-02
  - SEC-02
  - SEC-03
must_haves:
  truths:
    - "A completed audit can be inserted into Supabase from the browser using only the publishable anon key"
    - "The inserted audit returns a UUID primary key"
    - "An anonymous read on the audits table via anon key returns zero rows"
    - "Supabase Security Advisor shows no warnings on the audits table"
    - "No API keys other than VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_KEY exist in any VITE_ variable"
  artifacts:
    - path: "supabase://qyktrwpgfyvgdnexzcpr/public/audits"
      provides: "Audits table with confirmed RLS behavior"
    - path: "src/lib/supabase.ts"
      provides: "Live Supabase client connected to real project"
    - path: "src/lib/submitAudit.ts"
      provides: "Verified insert function returning UUID"
  key_links:
    - from: "browser (anon key)"
      to: "public.audits INSERT"
      via: "submitAudit() -> supabase.from('audits').insert().select('id').single()"
      pattern: "returns UUID, not null"
    - from: "browser (anon key)"
      to: "public.audits SELECT"
      via: "supabase.from('audits').select()"
      pattern: "returns empty array []"
---

<objective>
Verify that all Phase 1 success criteria are satisfied: the database accepts anonymous inserts, RLS blocks anonymous reads, the Security Advisor is clean, and no secret keys contaminate the client bundle.

Purpose: This plan bridges Plans 01 and 02 — confirming the database and client actually work together, not just that they were each created correctly in isolation. Automated checks run first; the human checkpoint confirms the browser round-trip.

Output: No new files. Verified system state. If any check fails, the executor diagnoses and fixes before completing.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-schema-and-environment/01-01-SUMMARY.md
@.planning/phases/01-schema-and-environment/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated backend and bundle verification</name>
  <files>No files modified — MCP and CLI verification only</files>
  <action>
    Run the following five checks against project `qyktrwpgfyvgdnexzcpr`. All must pass before proceeding to the checkpoint.

    **Check 1 — Table exists with RLS enabled:**
    Use `execute_sql` on project `qyktrwpgfyvgdnexzcpr`:
    ```sql
    SELECT tablename, rowsecurity
    FROM pg_tables
    WHERE tablename = 'audits' AND schemaname = 'public';
    ```
    Expected: one row with `rowsecurity = true`. If empty or `rowsecurity = false`, the Plan 01 migration did not complete correctly — re-apply it.

    **Check 2 — Correct policies and nothing extra:**
    Use `execute_sql`:
    ```sql
    SELECT policyname, cmd, roles, qual, with_check
    FROM pg_policies
    WHERE tablename = 'audits';
    ```
    Expected: exactly one row — `anon_can_insert_audits | INSERT | {anon} | <null> | true`.
    If any SELECT, UPDATE, or DELETE policies appear, diagnose immediately — they violate SEC-02 and must be dropped.

    **Check 3 — INSERT returns a UUID (service role test):**
    Use `execute_sql` (runs as service role, bypasses RLS — this tests schema correctness, not RLS):
    ```sql
    INSERT INTO public.audits (
      niche, business_name, contact_name, contact_email,
      overall_score, form_data, scores
    )
    VALUES (
      'home_services',
      'Verification Co',
      'Test User',
      'verify@test.com',
      72,
      '{"niche":"home_services","step1":{"businessName":"Verification Co","contactName":"Test User","email":"verify@test.com","phone":""}}'::jsonb,
      '{"overall":72,"technology":65,"leads":70,"scheduling":75,"communication":80,"followUp":68,"operations":72,"financial":74,"categories":[]}'::jsonb
    )
    RETURNING id, created_at;
    ```
    Expected: one row with a valid UUID in `id` and a timestamp in `created_at`.
    Record the returned UUID in the SUMMARY for audit trail.

    **Check 4 — Security Advisor clean:**
    Use `get_advisors` with type `security` on project `qyktrwpgfyvgdnexzcpr`.
    Confirm no warnings reference the `audits` table. Zero warnings on audits is the required state.

    **Check 5 — No secret keys in built bundle:**
    Run the production build and scan the dist output:
    ```bash
    npm run build
    grep -r "sb_secret_\|service_role" dist/ 2>/dev/null && echo "FAIL - secret found" || echo "CLEAN"
    ```
    Expected: `CLEAN`. The publishable key (`sb_publishable_...`) appearing in the bundle is expected and acceptable — it is designed to be public. Only service role and secret keys are prohibited.

    If any check fails: diagnose the root cause, fix it in the appropriate plan's artifacts (migration SQL or client code), and re-run only the failing check. Do not proceed to the checkpoint task until all five pass.
  </action>
  <verify>
    All five checks return expected results:
    1. audits table exists with rowsecurity = true
    2. Exactly one policy: anon_can_insert_audits (INSERT only for anon role)
    3. Service-role test insert returns a valid UUID
    4. Security Advisor: zero warnings on audits table
    5. Built bundle: no sb_secret_ or service_role strings
  </verify>
  <done>
    All five automated checks pass. The table, RLS policies, insert behavior, Security Advisor state, and bundle security are all confirmed correct.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Browser round-trip verification — insert returns UUID, anon read returns empty</name>
  <files>No files modified — human verification of browser behavior</files>
  <action>
    Pause for human verification. What was built: Phase 1 complete system — Supabase audits table with RLS (Plan 01) and the browser Supabase client plus submitAudit function (Plan 02). Automated checks confirmed the backend policies, Security Advisor state, and bundle security. This checkpoint confirms the actual browser-to-database round-trip using only the anon publishable key.

    **Prerequisite:** Your `.env` file must exist in the project root. If it does not exist yet, create it now by copying `.env.example` and filling in these exact values:
    ```
    VITE_SUPABASE_URL=https://qyktrwpgfyvgdnexzcpr.supabase.co
    VITE_SUPABASE_PUBLISHABLE_KEY=sb_publishable_aGBmVyDoU9Mbmlp939p1Ig_Hm9kvb0-
    ```

    **Step 1 — Start the dev server:**
    ```bash
    npm run dev
    ```
    Visit http://localhost:8080 (or whichever port Vite reports) and confirm the app loads without console errors.

    **Step 2 — Test the insert round-trip.** Open the browser console (F12 -> Console) and paste:
    ```javascript
    const { submitAudit } = await import('/src/lib/submitAudit.ts');
    const fakeFormState = {
      niche: 'home_services', currentStep: 8, completedSteps: [1,2,3,4,5,6,7,8],
      partnerCode: null,
      step1: { businessName: 'Browser Test Co', contactName: 'Browser User', email: 'browsertest@test.com', phone: '555-0100' },
      step2: { primaryCRM: 'HubSpot', crmSatisfaction: 3, toolsUsed: [], techFrustrations: 'Too many apps' },
      step3: { leadSources: ['referral'], responseSpeed: 'within_hour', leadTracking: 'crm', conversionRate: '20-30', googleReviews: '4.5', reviewAutomation: 'manual' },
      step4: { schedulingMethod: 'software', dispatchMethod: 'manual', routeOptimization: 'no', realTimeTracking: 'no', capacityPlanning: 'no', emergencyHandling: 'callback' },
      step5: { internalComms: 'slack', afterHoursComms: 'phone', clientPortal: 'no' },
      step6: { repeatBusinessPercent: '40-60' },
      step7: { kpisTracked: ['revenue'] },
      step8: { paymentMethods: ['credit_card'], biggestChallenge: 'Scheduling' }
    };
    const fakeScores = { technology: 55, leads: 60, scheduling: 50, communication: 65, followUp: 58, operations: 62, financial: 70, overall: 60, categories: [] };
    const id = await submitAudit(fakeFormState, fakeScores);
    console.log('SUCCESS - UUID:', id);
    ```
    Expected: Console prints `SUCCESS - UUID: <some-uuid-value>`. If an error appears instead, copy the message exactly and report it.

    **Step 3 — Test RLS blocks reads.** In the same browser console, paste:
    ```javascript
    const { supabase } = await import('/src/lib/supabase.ts');
    const { data, error } = await supabase.from('audits').select('*');
    console.log('Read result:', { rowCount: data?.length, error });
    ```
    Expected: `rowCount: 0` and `error: null`. If `rowCount` is greater than 0, RLS is not working — stop and report.

    **Step 4 (optional) — Confirm the row landed.** Visit https://supabase.com/dashboard/project/qyktrwpgfyvgdnexzcpr/editor and run:
    ```sql
    SELECT id, niche, business_name, overall_score, created_at FROM public.audits ORDER BY created_at DESC LIMIT 5;
    ```
    You should see the test row from Step 2 plus the verification row from Task 1.
  </action>
  <verify>
    Browser console shows:
    1. Step 2 insert: `SUCCESS - UUID: <uuid>` (not an error)
    2. Step 3 read: `rowCount: 0` and `error: null`
  </verify>
  <done>
    User types "approved" after both browser tests pass (insert returned UUID, read returned rowCount 0). Phase 1 is complete.
  </done>
</task>

</tasks>

<verification>
Phase 1 success criteria (from ROADMAP.md) — all must be TRUE:
1. A completed audit can be inserted into Supabase from the browser using only the publishable anon key — verified by browser console test in checkpoint
2. The audits table has a UUID primary key that is returned after each insert — verified by Check 3 and browser test
3. An anonymous user querying the audits table via the anon key receives zero rows — verified by browser console read test in checkpoint
4. Supabase Security Advisor shows no warnings on the audits table — verified by Check 4
5. No API keys other than VITE_SUPABASE_URL and VITE_SUPABASE_PUBLISHABLE_KEY exist in any VITE_ environment variable — verified by Check 5 bundle scan
</verification>

<success_criteria>
All five phase success criteria confirmed: automated checks passed (Task 1) and user typed "approved" after browser round-trip verified insert returns UUID and anon read returns empty array (Task 2 checkpoint).
</success_criteria>

<output>
After completion, create `.planning/phases/01-schema-and-environment/01-03-SUMMARY.md` using the summary template. Include: results of all five automated checks with pass/fail status, the UUID from the MCP test insert, confirmation that browser round-trip test passed, and all five Phase 1 success criteria with PASS status. Then update STATE.md: advance Phase to 2, mark Phase 1 complete in the Progress table.
</output>
