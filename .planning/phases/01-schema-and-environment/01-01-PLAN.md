---
phase: 01-schema-and-environment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements:
  - DATA-01
  - DATA-02
  - SEC-02
user_setup:
  - service: supabase
    why: "The AiAudit project is on the free plan. Free tier projects pause after 7 days of inactivity, which will break development mid-phase. Upgrade before the migration runs."
    dashboard_config:
      - task: "Upgrade to Pro plan"
        location: "Supabase Dashboard -> Organization (zxqjswomdzqljryizsxg) -> Settings -> Billing -> Upgrade to Pro"
must_haves:
  truths:
    - "The audits table exists in the public schema of project qyktrwpgfyvgdnexzcpr"
    - "An anonymous insert into audits succeeds and returns a UUID"
    - "An anonymous SELECT on audits returns zero rows (RLS blocks reads)"
    - "No permissive SELECT policy exists for the anon role"
  artifacts:
    - path: "supabase://qyktrwpgfyvgdnexzcpr/public/audits"
      provides: "Audit persistence table"
      contains: "id UUID PRIMARY KEY, niche TEXT, business_name TEXT, contact_name TEXT, contact_email TEXT, contact_phone TEXT, partner_code TEXT, overall_score INTEGER, form_data JSONB, scores JSONB, created_at TIMESTAMPTZ"
  key_links:
    - from: "public.audits"
      to: "anon role INSERT policy"
      via: "CREATE POLICY anon_can_insert_audits"
      pattern: "FOR INSERT TO anon WITH CHECK"
    - from: "public.audits"
      to: "RLS enforcement"
      via: "ALTER TABLE ENABLE ROW LEVEL SECURITY"
      pattern: "ENABLE ROW LEVEL SECURITY"
---

<objective>
Create the audits table in Supabase with full RLS security applied in a single migration. The migration creates the table, enables RLS, and creates the anon INSERT policy as one atomic block — never a table without RLS even for a moment.

Purpose: This is the foundational backend artifact. Every other phase depends on this table existing with correct security. RLS must be enabled at creation time per the CVE-2025-48757 precedent locked in project decisions.

Output: A migrated Supabase table (audits) in the AiAudit project that accepts anonymous inserts and returns zero rows on anonymous reads.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-schema-and-environment/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audits table with RLS via Supabase MCP migration</name>
  <files>supabase://qyktrwpgfyvgdnexzcpr — migration applied via MCP apply_migration</files>
  <action>
    Use the Supabase MCP tool `apply_migration` on project `qyktrwpgfyvgdnexzcpr` with migration name `create_audits_table` and the following SQL exactly as written — do not alter column types or constraints:

    ```sql
    CREATE TABLE public.audits (
      id            UUID        PRIMARY KEY DEFAULT gen_random_uuid(),
      niche         TEXT        NOT NULL CHECK (niche IN ('home_services', 'real_estate')),
      business_name TEXT        NOT NULL,
      contact_name  TEXT        NOT NULL,
      contact_email TEXT        NOT NULL,
      contact_phone TEXT,
      partner_code  TEXT,
      overall_score INTEGER     NOT NULL CHECK (overall_score BETWEEN 0 AND 100),
      form_data     JSONB       NOT NULL,
      scores        JSONB       NOT NULL,
      created_at    TIMESTAMPTZ NOT NULL DEFAULT now()
    );

    -- Enable RLS at creation time (CVE-2025-48757 precedent: never add RLS later)
    ALTER TABLE public.audits ENABLE ROW LEVEL SECURITY;

    -- Allow anonymous users to insert audit submissions
    CREATE POLICY "anon_can_insert_audits"
    ON public.audits
    FOR INSERT
    TO anon
    WITH CHECK (true);

    -- No SELECT policy for anon = reads return zero rows (SEC-02 compliant)
    -- No UPDATE or DELETE policies = those operations blocked for all roles
    ```

    After the migration succeeds, verify using `list_tables` that `audits` appears in the public schema. Then use `execute_sql` to run:
    ```sql
    SELECT tablename, rowsecurity FROM pg_tables WHERE tablename = 'audits' AND schemaname = 'public';
    ```
    Confirm `rowsecurity` is `true`.

    Do NOT create a SELECT policy for the anon role — its absence is the security mechanism for SEC-02.
    Do NOT use `USING (true)` on any policy — that pattern triggers Security Advisor lint 0024.
    The INSERT policy correctly uses `WITH CHECK (true)` only, which does not trigger the lint.
  </action>
  <verify>
    1. `list_migrations` via MCP shows `create_audits_table` in migration history
    2. `list_tables` via MCP shows `audits` in public schema
    3. `execute_sql` query `SELECT rowsecurity FROM pg_tables WHERE tablename = 'audits'` returns `true`
    4. `execute_sql` query `SELECT policyname, cmd FROM pg_policies WHERE tablename = 'audits'` returns exactly one row: `anon_can_insert_audits | INSERT`
  </verify>
  <done>
    The audits table exists in the public schema with RLS enabled and a single INSERT policy for the anon role. No SELECT, UPDATE, or DELETE policies exist for any anonymous role. The migration appears in migration history.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run Security Advisor and confirm no warnings on audits table</name>
  <files>No files modified — MCP verification only</files>
  <action>
    Use the Supabase MCP tool `get_advisors` with type `security` on project `qyktrwpgfyvgdnexzcpr`.

    Review the output for any warnings referencing the `audits` table. The expected state is zero warnings on `audits`.

    The lint to watch for is `0024_permissive_rls_policy` — this fires on `USING (true)` SELECT policies. Our schema has no SELECT policy at all, so this lint should not fire.

    If any warnings DO appear on the audits table, diagnose and fix before marking this task done. Common false positive: if the advisor flags an INSERT-only `WITH CHECK (true)` policy, that is a bug in older advisor versions — document the finding but do not add a restrictive `WITH CHECK` that would break anonymous submissions.

    Also run the performance advisor:
    Use `get_advisors` with type `performance` on project `qyktrwpgfyvgdnexzcpr`.
    Note any suggestions but do not act on them in Phase 1 — performance tuning is out of scope here.
  </action>
  <verify>
    Security advisor output contains no warnings referencing the `audits` table.
  </verify>
  <done>
    Supabase Security Advisor reports zero warnings on the audits table. Success criterion 4 from the phase roadmap is satisfied.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Migration history includes `create_audits_table`
2. `SELECT rowsecurity FROM pg_tables WHERE tablename = 'audits'` returns `true`
3. `SELECT policyname, cmd FROM pg_policies WHERE tablename = 'audits'` returns exactly: `anon_can_insert_audits | INSERT`
4. Security Advisor shows no warnings on audits table
</verification>

<success_criteria>
- audits table exists in public schema of project qyktrwpgfyvgdnexzcpr
- RLS is enabled (rowsecurity = true)
- Exactly one policy exists: anon INSERT with WITH CHECK (true)
- No SELECT policy for anon role
- Security Advisor clean
</success_criteria>

<output>
After completion, create `.planning/phases/01-schema-and-environment/01-01-SUMMARY.md` using the summary template. Include: migration name, table schema (columns + types), RLS status, policies created, Security Advisor result, and the Supabase project ID for downstream plan reference.
</output>
