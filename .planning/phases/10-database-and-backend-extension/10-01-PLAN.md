---
phase: 10-database-and-backend-extension
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260222120000_add_language_and_sub_niche.sql
  - src/lib/submitAudit.ts
  - src/pages/Loading.tsx
  - src/lib/fetchReport.ts
  - supabase/functions/fetch-report/index.ts
  - supabase/functions/generate-report/index.ts
autonomous: true
requirements:
  - DB-01
  - DB-03

must_haves:
  truths:
    - "A submitted audit row contains the correct language code (en or bg) and sub-niche key"
    - "The fetch-report edge function returns language and sub_niche fields to the frontend"
    - "Cyrillic free-text input passes through sanitizeText() and sanitizeBusinessName() intact"
    - "Emoji characters are stripped from free-text fields while preserving all natural-language scripts"
    - "Old audit rows with null language/sub_niche do not cause errors"
  artifacts:
    - path: "supabase/migrations/20260222120000_add_language_and_sub_niche.sql"
      provides: "language and sub_niche nullable columns on audits table"
      contains: "ADD COLUMN language TEXT"
    - path: "src/lib/submitAudit.ts"
      provides: "language and sub_niche included in INSERT"
      contains: "language"
    - path: "src/lib/fetchReport.ts"
      provides: "FetchReportResult type with language and sub_niche fields"
      contains: "language"
    - path: "supabase/functions/fetch-report/index.ts"
      provides: "language and sub_niche in SELECT query"
      contains: "language, sub_niche"
    - path: "supabase/functions/generate-report/index.ts"
      provides: "Unicode-aware sanitizeText and sanitizeBusinessName"
      contains: "\\p{L}"
  key_links:
    - from: "src/pages/Loading.tsx"
      to: "src/lib/submitAudit.ts"
      via: "passes lang from useLang() hook as language parameter"
      pattern: "submitAudit\\(formState.*lang"
    - from: "src/lib/submitAudit.ts"
      to: "supabase audits table"
      via: "includes language and sub_niche in insert payload"
      pattern: "language.*sub_niche"
    - from: "supabase/functions/fetch-report/index.ts"
      to: "src/lib/fetchReport.ts"
      via: "returns language and sub_niche in response, typed in FetchReportResult"
      pattern: "language.*sub_niche"
---

<objective>
Add language and sub-niche columns to the audits table, wire them through the frontend submission and fetch paths, and fix Cyrillic-stripping sanitization in the generate-report edge function.

Purpose: Phase 11 (Bulgarian content) depends on these fields being persisted and Cyrillic text flowing through to the AI. Without this plumbing, Bulgarian audits would lose their language/sub-niche context and have all Cyrillic text stripped from AI prompts.

Output: Migration file, updated submitAudit with language parameter, updated fetch-report returning new fields, Unicode-aware sanitization functions.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-database-and-backend-extension/10-CONTEXT.md
@.planning/phases/10-database-and-backend-extension/10-RESEARCH.md

@src/lib/submitAudit.ts
@src/pages/Loading.tsx
@src/lib/fetchReport.ts
@supabase/functions/fetch-report/index.ts
@supabase/functions/generate-report/index.ts
@supabase/migrations/20260219055745_create_audits_table.sql
@src/hooks/useLang.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration and wire submitAudit with language and sub_niche</name>
  <files>
    supabase/migrations/20260222120000_add_language_and_sub_niche.sql
    src/lib/submitAudit.ts
    src/pages/Loading.tsx
  </files>
  <action>
1. Create migration file `supabase/migrations/20260222120000_add_language_and_sub_niche.sql`:
   ```sql
   ALTER TABLE public.audits
     ADD COLUMN language TEXT,
     ADD COLUMN sub_niche TEXT;
   ```
   Both columns are nullable with no DEFAULT (per CONTEXT.md: old rows untouched, no backfill). No CHECK constraints (frontend enforces valid values, and adding constraints limits future extensibility).

2. Update `src/lib/submitAudit.ts`:
   - Add a third parameter `language: string` to the `submitAudit` function signature
   - Add `sub_niche: formState.subNiche ?? null` and `language` to the insert object
   - The sub_niche value comes from `formState.subNiche` which already exists in AuditFormState (added in Phase 8)
   - Final signature: `submitAudit(formState: AuditFormState, scores: AuditScores, language: string): Promise<string>`

3. Update `src/pages/Loading.tsx`:
   - The `useLang()` hook is already imported (line 9) and destructured as `{ prefix }` (line 16)
   - Update the destructuring to also extract `lang`: `const { prefix, lang } = useLang()`
   - Update the single call site at line 177 in `runAuditFlow()`: change `submitAudit(formState!, scores!)` to `submitAudit(formState!, scores!, lang)`

NOTE: `lang` from `useLang()` returns the two-letter language code (e.g., 'en' or 'bg') derived from the URL parameter, which is the single source of truth for language (per Phase 6 design). This is the most reliable source at submission time.
  </action>
  <verify>
    Run `npm run build` — TypeScript compilation must succeed with no errors (verifies the submitAudit signature change is correctly propagated to its single call site in Loading.tsx).
  </verify>
  <done>
    Migration file exists with two nullable ALTER TABLE ADD COLUMN statements. submitAudit accepts a language parameter and includes both language and sub_niche in the insert payload. Loading.tsx passes lang from useLang() to submitAudit. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update fetch-report edge function and FetchReportResult type</name>
  <files>
    supabase/functions/fetch-report/index.ts
    src/lib/fetchReport.ts
  </files>
  <action>
1. Update `supabase/functions/fetch-report/index.ts`:
   - Add `language` and `sub_niche` to the `.select()` string on the audits query (currently line 34):
     Change from: `'id, niche, business_name, form_data, scores, report_status, created_at'`
     Change to: `'id, niche, business_name, form_data, scores, report_status, created_at, language, sub_niche'`
   - No other changes needed — the audit object is already returned directly in the response JSON

2. Update `src/lib/fetchReport.ts`:
   - Add `language` and `sub_niche` fields to the `FetchReportResult.audit` type interface:
     ```typescript
     audit: {
       id: string;
       niche: string;
       business_name: string;
       form_data: AuditFormState;
       scores: AuditScores;
       report_status: 'pending' | 'completed' | 'failed';
       created_at: string;
       language: string | null;   // NEW — null for legacy audits
       sub_niche: string | null;  // NEW — null for legacy audits
     };
     ```
   - Both fields are `string | null` because legacy audit rows will have null values (per CONTEXT.md: no backfill)
  </action>
  <verify>
    Run `npm run build` — TypeScript compilation must succeed. Verify the FetchReportResult type includes both new fields by checking no type errors in any file that imports it.
  </verify>
  <done>
    fetch-report edge function SELECT includes language and sub_niche. FetchReportResult type has both nullable fields. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix sanitizeText and sanitizeBusinessName for Cyrillic and emoji</name>
  <files>
    supabase/functions/generate-report/index.ts
  </files>
  <action>
1. Replace the `sanitizeText` function in `supabase/functions/generate-report/index.ts` (currently lines 13-21) with a Unicode-aware version:
   ```typescript
   function sanitizeText(input: string | undefined, maxLen: number = 500): string {
     if (!input) return ''
     return input
       .replace(/<[^>]*>/g, '')                    // strip HTML tags
       .replace(/\p{Emoji_Presentation}/gu, '')    // strip emoji (keep text chars)
       .replace(/[^\p{L}\p{N}\s.,!?'-]/gu, ' ')   // keep letters (any script), digits, common punctuation
       .replace(/\s+/g, ' ')                       // normalize whitespace
       .trim()
       .slice(0, maxLen)
   }
   ```
   Key changes:
   - Added emoji stripping with `\p{Emoji_Presentation}` (per CONTEXT.md: strip emoji, keep natural-language scripts)
   - Replaced `\w` with `\p{L}\p{N}` — `\w` is ASCII-only (`[A-Za-z0-9_]`) and strips ALL Cyrillic. `\p{L}` matches any Unicode letter (Latin, Cyrillic, etc.), `\p{N}` matches any Unicode digit
   - Added `/u` flag to enable Unicode property escapes (supported in Deno's V8 engine since 2018)
   - Logging: silent (per CONTEXT.md decision)

2. Replace the `sanitizeBusinessName` function (currently lines 23-31) with the same Unicode-aware approach:
   ```typescript
   function sanitizeBusinessName(name: string | undefined): string {
     if (!name) return 'Your Business'
     return name
       .replace(/<[^>]*>/g, '')                    // strip HTML tags
       .replace(/\p{Emoji_Presentation}/gu, '')    // strip emoji
       .replace(/[^\p{L}\p{N}\s.,&'-]/gu, ' ')    // keep letters, digits, & for business names
       .replace(/\s+/g, ' ')                       // normalize whitespace
       .trim()
       .slice(0, 100)
   }
   ```
   Same changes as sanitizeText, plus preserving `&` which is common in business names (already preserved in the original).

IMPORTANT: The `\p{Emoji_Presentation}` property matches characters that default to emoji display. It does NOT match ASCII digits, `#`, or `*` (which have emoji variants but are primarily text characters). This is the correct property per the research pitfall analysis.

IMPORTANT: Do NOT change the `\w` in JavaScript to `\p{L}\p{N}` expecting `\w` to behave differently with the `/u` flag — JavaScript's `\w` remains ASCII-only even with `/u`. The `/u` flag only enables `\p{}` property escapes.
  </action>
  <verify>
    Verify the regex changes are correct by visual inspection of the updated functions. The edge function runs in Deno (V8), which supports Unicode property escapes. Confirm no other uses of `\w` in the file that might also need updating. Run `npm run build` (frontend only — edge functions deploy separately, but this confirms no accidental frontend breakage).
  </verify>
  <done>
    sanitizeText() uses `\p{L}\p{N}` instead of `\w`, preserving Cyrillic and all Unicode letters. sanitizeBusinessName() uses the same Unicode-aware pattern. Both functions strip emoji via `\p{Emoji_Presentation}`. The AI prompt will receive Bulgarian free-text intact.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors — confirms TypeScript compilation of submitAudit signature change, Loading.tsx call site update, and FetchReportResult type extension
2. Migration file `supabase/migrations/20260222120000_add_language_and_sub_niche.sql` exists and contains `ADD COLUMN language TEXT` and `ADD COLUMN sub_niche TEXT` with no DEFAULT or NOT NULL constraints
3. `submitAudit` function signature includes `language: string` parameter, and insert payload includes both `language` and `sub_niche` fields
4. `fetch-report/index.ts` SELECT string includes `language, sub_niche`
5. `FetchReportResult.audit` type includes `language: string | null` and `sub_niche: string | null`
6. `sanitizeText` and `sanitizeBusinessName` use `\p{L}\p{N}` with `/u` flag instead of `\w`
7. Both sanitization functions include `\p{Emoji_Presentation}` emoji stripping step
</verification>

<success_criteria>
- Build passes with zero errors
- Migration file is valid SQL adding two nullable columns
- submitAudit includes language and sub_niche in database insert
- fetch-report returns both new fields to the frontend
- Sanitization preserves Cyrillic characters while stripping HTML, emoji, and control characters
</success_criteria>

<output>
After completion, create `.planning/phases/10-database-and-backend-extension/10-01-SUMMARY.md`
</output>
