---
phase: 10-database-and-backend-extension
plan: 02
type: execute
wave: 2
depends_on:
  - 10-01
files_modified:
  - supabase/functions/send-notification/index.ts
autonomous: true
requirements:
  - DB-02

must_haves:
  truths:
    - "The admin notification email displays the human-readable language name (English or Bulgarian) for new audits"
    - "The admin notification email displays the human-readable sub-niche label (e.g., HVAC, Plumbing) for new audits"
    - "Legacy audits with null language/sub-niche do not show those rows in the email"
    - "The View Full Report link in the email uses the correct language-prefixed URL (/en/report/:id for English, /report/:id for Bulgarian)"
    - "The user email report link also uses the correct language-prefixed URL"
  artifacts:
    - path: "supabase/functions/send-notification/index.ts"
      provides: "Language and sub-niche display in admin email, language-aware report URLs"
      contains: "LANGUAGE_LABELS"
  key_links:
    - from: "supabase/functions/send-notification/index.ts"
      to: "audits table webhook record"
      via: "reads record.language and record.sub_niche from webhook payload"
      pattern: "record\\.language"
    - from: "supabase/functions/send-notification/index.ts"
      to: "email report URL"
      via: "builds language-aware report URL using record.language"
      pattern: "langPrefix.*report"
---

<objective>
Update the send-notification edge function to display language and sub-niche in the admin email, and make report URLs language-aware.

Purpose: Administrators need to see which language and sub-niche a completed audit used, and email report links must open in the correct language. This completes the DB-02 requirement.

Output: Updated send-notification edge function with language/sub-niche display rows and language-aware URLs.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-database-and-backend-extension/10-CONTEXT.md
@.planning/phases/10-database-and-backend-extension/10-RESEARCH.md
@.planning/phases/10-database-and-backend-extension/10-01-SUMMARY.md

@supabase/functions/send-notification/index.ts
@supabase/functions/generate-report/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add language and sub-niche to AuditRecord type and label maps</name>
  <files>
    supabase/functions/send-notification/index.ts
  </files>
  <action>
1. Update the `AuditRecord` interface to include the new nullable fields (after the existing fields):
   ```typescript
   interface AuditRecord {
     // ... existing fields ...
     language: string | null     // NEW — null for legacy audits
     sub_niche: string | null    // NEW — null for legacy audits
   }
   ```

2. Add label lookup maps near the top of the file (after the type definitions, before the email helpers):
   ```typescript
   // Language display labels — full names per CONTEXT.md decision
   const LANGUAGE_LABELS: Record<string, string> = {
     en: 'English',
     bg: 'Bulgarian',
   }

   // Sub-niche display labels — must stay in sync with SUB_NICHE_REGISTRY in src/config/subNicheConfig.ts
   const SUB_NICHE_LABELS: Record<string, string> = {
     hvac: 'HVAC', plumbing: 'Plumbing', electrical: 'Electrical', garage_doors: 'Garage Doors',
     pest_control: 'Pest Control', landscaping: 'Landscaping', cleaning: 'Cleaning',
     roofing: 'Roofing', painting: 'Painting', general_contracting: 'General Contracting',
     construction: 'Construction', interior_design: 'Interior Design',
     residential_sales: 'Residential Sales', commercial: 'Commercial / Office',
     property_management: 'Property Management', new_construction: 'New Construction',
     luxury_resort: 'Luxury / Resort',
   }
   ```
   NOTE: This duplicates the map from generate-report/index.ts. Edge functions deploy independently, so sharing via `_shared/` would add a deployment coupling. Keep the duplication with the sync comment, following the established pattern from Phase 9.
  </action>
  <verify>
    Visual inspection: AuditRecord has both new nullable fields. Both label maps are present with correct values (17 sub-niches, 2 languages).
  </verify>
  <done>
    AuditRecord interface includes language and sub_niche. LANGUAGE_LABELS and SUB_NICHE_LABELS maps are defined with correct entries and sync comments.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update admin and user email templates with language/sub-niche display and language-aware URLs</name>
  <files>
    supabase/functions/send-notification/index.ts
  </files>
  <action>
1. Update `buildAdminEmailHtml` function:

   a. Build the language-aware report URL. The app's routing scheme is: Bulgarian = no prefix (default), English = `/en/` prefix. Per research pitfall analysis, CONTEXT.md says `/bg/report/:id` for Bulgarian but the actual app routing redirects `/bg/*` to `/*`. Use the actual routing behavior to avoid redirect flashes:
      ```typescript
      const langPrefix = record.language === 'en' ? '/en' : ''
      const reportUrl = `https://bizaudit.epsystems.dev${langPrefix}/report/${record.id}`
      ```
      Replace the existing hardcoded `reportUrl` on line 131.

   b. Add conditional language and sub-niche rows in the Contact section (after the Niche row, before the closing `</table>`). Per CONTEXT.md: omit lines entirely if data is null (legacy audits):
      ```typescript
      const languageDisplay = record.language ? (LANGUAGE_LABELS[record.language] ?? record.language) : null
      const subNicheDisplay = record.sub_niche ? (SUB_NICHE_LABELS[record.sub_niche] ?? record.sub_niche) : null

      const languageRow = languageDisplay
        ? `<tr><td style="padding: 4px 0; font-size: 14px; color: #6b7280; width: 100px;">Language</td><td style="padding: 4px 0; font-size: 14px; color: #111827;">${escapeHtml(languageDisplay)}</td></tr>`
        : ''
      const subNicheRow = subNicheDisplay
        ? `<tr><td style="padding: 4px 0; font-size: 14px; color: #6b7280; width: 100px;">Sub-niche</td><td style="padding: 4px 0; font-size: 14px; color: #111827;">${escapeHtml(subNicheDisplay)}</td></tr>`
        : ''
      ```
      Insert `${languageRow}` and `${subNicheRow}` after the Niche `<tr>` in the Contact section of the HTML template.

   c. The fallback `?? record.language` / `?? record.sub_niche` in the display logic handles any future language or sub-niche values not yet in the label maps — it shows the raw key rather than crashing.

2. Update `buildUserEmailHtml` function:

   a. Replace the hardcoded `reportUrl` with the same language-aware URL pattern:
      ```typescript
      const langPrefix = record.language === 'en' ? '/en' : ''
      const reportUrl = `https://bizaudit.epsystems.dev${langPrefix}/report/${record.id}`
      ```
      This ensures user email links also open in the correct language.

   b. No language/sub-niche display rows needed in the user email — users already know their own language and sub-niche. Only the admin needs this information.

3. Update the email subject line in the main handler to include sub-niche when available (around line 447):
   - Current: `New Audit: ${record.contact_name} — ${nicheLabel} (${record.overall_score}/100)`
   - Updated: If sub-niche exists, append it: `New Audit: ${record.contact_name} — ${nicheLabel} / ${subNicheDisplay} (${record.overall_score}/100)`
   - If no sub-niche (legacy), keep the current format
   - Resolve the display values in the main handler scope (they are needed for both the subject and the email body):
     ```typescript
     const subNicheDisplay = record.sub_niche ? (SUB_NICHE_LABELS[record.sub_niche] ?? record.sub_niche) : null
     const subjectNiche = subNicheDisplay ? `${nicheLabel} / ${subNicheDisplay}` : nicheLabel
     ```
     Then use `subjectNiche` in the subject line.

IMPORTANT: The `buildAdminEmailHtml` and `buildUserEmailHtml` functions receive the `record` parameter which is the full webhook payload row. After Plan 01's migration adds the `language` and `sub_niche` columns, the webhook automatically delivers them in the record. The TypeScript interface update (Task 1) makes them accessible. The code must handle null gracefully for legacy rows.
  </action>
  <verify>
    Visual inspection of the updated send-notification/index.ts:
    1. The admin email HTML includes conditional Language and Sub-niche rows in the Contact section
    2. Both `buildAdminEmailHtml` and `buildUserEmailHtml` use the language-aware report URL
    3. The email subject includes sub-niche when available
    4. All null checks are present for legacy audit compatibility
    5. Run `npm run build` to confirm no frontend breakage (edge functions are separate but this confirms nothing else broke)
  </verify>
  <done>
    Admin email displays Language and Sub-niche rows (omitted when null). Report URLs in both admin and user emails are language-aware (/en/ prefix for English, no prefix for Bulgarian). Email subject includes sub-niche when available. All null cases handled gracefully for legacy audits.
  </done>
</task>

</tasks>

<verification>
1. `send-notification/index.ts` AuditRecord interface includes `language: string | null` and `sub_niche: string | null`
2. LANGUAGE_LABELS map has entries for 'en' and 'bg' with full names
3. SUB_NICHE_LABELS map has all 17 sub-niche entries with human-readable labels
4. Admin email Contact section includes conditional Language and Sub-niche rows
5. Both email templates use `langPrefix` for language-aware report URLs
6. Null language/sub-niche produces no display rows (legacy audit compatibility)
7. Email subject includes sub-niche when present
8. `npm run build` passes (no frontend breakage)
</verification>

<success_criteria>
- Admin notification email shows human-readable language name and sub-niche label for new audits
- Legacy audits with null language/sub-niche render the email without those rows
- Report URLs in both admin and user emails use correct language prefix
- Email subject line enriched with sub-niche when available
</success_criteria>

<output>
After completion, create `.planning/phases/10-database-and-backend-extension/10-02-SUMMARY.md`
</output>
