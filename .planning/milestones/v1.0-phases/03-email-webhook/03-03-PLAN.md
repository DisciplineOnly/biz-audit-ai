---
phase: 03-email-webhook
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified: []
autonomous: false
requirements: [EMAIL-01, EMAIL-02]

must_haves:
  truths:
    - "The send-notification edge function is deployed and accessible at the project's edge function URL"
    - "RESEND_API_KEY and ADMIN_EMAIL are stored as Supabase secrets"
    - "A Database Webhook named on_report_completed fires on audits UPDATE and calls send-notification"
    - "An end-to-end test confirms the admin receives an email when report_status changes to 'completed'"
    - "EMAIL-02 (user email) is documented as deferred, not implemented"
  artifacts: []
  key_links:
    - from: "Database Webhook (on_report_completed)"
      to: "supabase/functions/send-notification"
      via: "HTTP POST on audits UPDATE event"
      pattern: "functions/v1/send-notification"
---

<objective>
Deploy the send-notification edge function, apply the Phase 3 migration, store required secrets, configure the Database Webhook, and verify end-to-end that admin email delivery works. Document EMAIL-02 as deferred.

Purpose: This plan takes all the code artifacts from Plans 01-02 and makes them live. The Database Webhook is the critical wiring that connects the generate-report completion event to the send-notification email function. This plan also formally documents that EMAIL-02 (user email) is deferred until a custom Resend domain is verified.

Output: Deployed and verified email notification system. No new code files.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-email-webhook/03-RESEARCH.md
@.planning/phases/03-email-webhook/03-01-SUMMARY.md
@.planning/phases/03-email-webhook/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy edge functions and apply migration</name>
  <files></files>
  <action>
This task covers deployment steps that Claude can automate via CLI and MCP.

**Step 1: Apply the Phase 3 migration to remote DB.**
The migration file from Plan 01 (add_email_status_and_audit_reports.sql) must be applied to the remote Supabase project. This follows the same pattern as Phase 1 and Phase 2: the executor creates the SQL file but migration application requires MCP or Dashboard.

If MCP tools are available, use apply_migration. If not, note this for the orchestrator (same pattern as prior phases).

**Step 2: Deploy the send-notification edge function.**
```bash
supabase functions deploy send-notification --project-ref qyktrwpgfyvgdnexzcpr
```
This deploys the function from supabase/functions/send-notification/index.ts.

**Step 3: Also redeploy generate-report** (it was updated in Plan 01 to upsert into audit_reports):
```bash
supabase functions deploy generate-report --project-ref qyktrwpgfyvgdnexzcpr
```

**Step 4: Store Supabase secrets** (if not already set):
The RESEND_API_KEY and ADMIN_EMAIL secrets need to be set. Check if they exist first. If the executor has CLI access:
```bash
supabase secrets set RESEND_API_KEY=re_xxxxxxxxxxxx --project-ref qyktrwpgfyvgdnexzcpr
supabase secrets set ADMIN_EMAIL=admin@example.com --project-ref qyktrwpgfyvgdnexzcpr
```
The actual values must come from the user. If the executor cannot set secrets, document this as a required user action before verification.

NOTE: The executor may lack CLI access or MCP tools for some of these steps. Follow the established pattern: do what's possible, document what needs orchestrator/user action.
  </action>
  <verify>
If deploy was successful:
- `supabase functions list --project-ref qyktrwpgfyvgdnexzcpr` shows both generate-report and send-notification
- Migration is applied (email_status column and audit_reports table exist in remote DB)
  </verify>
  <done>send-notification and updated generate-report are deployed. Migration is applied. RESEND_API_KEY and ADMIN_EMAIL secrets are stored.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure Database Webhook in Supabase Dashboard</name>
  <files></files>
  <action>
The Database Webhook must be configured via the Supabase Dashboard. There is no CLI command for webhook creation.

**Configure the webhook with these exact settings:**

1. Go to Supabase Dashboard -> Database -> Webhooks -> Create a new hook
2. **Name:** `on_report_completed`
3. **Table:** `audits`
4. **Events:** CHECK only `UPDATE` (uncheck INSERT and DELETE)
5. **Type:** HTTP Request
6. **Method:** POST
7. **URL:** `https://qyktrwpgfyvgdnexzcpr.supabase.co/functions/v1/send-notification`
8. **HTTP Headers:** Add one header:
   - Name: `Authorization`
   - Value: `Bearer [your-service-role-key]`
   (Get the service_role key from Project Settings -> API -> service_role key)
9. **Timeout:** 5000 (5 seconds)
10. Click **Create**

**IMPORTANT:** The webhook fires on ALL UPDATE events to the audits table. The edge function handles filtering internally (checks report_status === 'completed'). Do NOT try to add column filters in the webhook config — Supabase Dashboard webhooks do not support column-level filtering.

**Also verify secrets are set:**
If the executor was unable to set RESEND_API_KEY and ADMIN_EMAIL via CLI in Task 1:
1. Go to Project Settings -> Edge Functions -> Secrets
2. Add `RESEND_API_KEY` with your Resend API key (from https://resend.com/api-keys)
3. Add `ADMIN_EMAIL` with the admin email address
   - IMPORTANT: This email MUST be the same email you used to create your Resend account (onboarding@resend.dev can only deliver to the account owner's verified email)

Type "webhook configured" when the Database Webhook is created and secrets are verified.
  </action>
  <verify>Webhook appears in Supabase Dashboard -> Database -> Webhooks list, named on_report_completed, targeting the audits table on UPDATE events.</verify>
  <done>Database Webhook on_report_completed is configured and active. RESEND_API_KEY and ADMIN_EMAIL secrets are stored.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end email delivery verification</name>
  <files></files>
  <action>
Verify the complete email notification pipeline: generate-report writes AI report to audit_reports table, sets report_status to 'completed', Database Webhook fires and calls send-notification, which reads the AI report, builds an admin email, and sends it via Resend.

**End-to-end test via curl:**

1. First, insert a test audit row (if you don't have one already):
```bash
curl -X POST "https://qyktrwpgfyvgdnexzcpr.supabase.co/rest/v1/audits" \
  -H "apikey: [anon-key]" \
  -H "Authorization: Bearer [anon-key]" \
  -H "Content-Type: application/json" \
  -d '{
    "niche": "home_services",
    "business_name": "Test Plumbing Co",
    "contact_name": "Test User",
    "contact_email": "test@example.com",
    "contact_phone": "555-0100",
    "overall_score": 42,
    "form_data": {"step1":{"businessName":"Test Plumbing Co"}},
    "scores": {"overall":42,"categories":[{"category":"technology","label":"Technology","score":35,"weight":15},{"category":"leads","label":"Lead Management","score":50,"weight":20},{"category":"scheduling","label":"Scheduling","score":40,"weight":15},{"category":"communication","label":"Communication","score":45,"weight":10},{"category":"followUp","label":"Follow-Up","score":30,"weight":15},{"category":"operations","label":"Operations","score":55,"weight":10},{"category":"financial","label":"Financial","score":40,"weight":15}]}
  }'
```

2. Call generate-report with the test audit ID to trigger the full pipeline:
```bash
curl -X POST "https://qyktrwpgfyvgdnexzcpr.supabase.co/functions/v1/generate-report" \
  -H "Authorization: Bearer [anon-key]" \
  -H "Content-Type: application/json" \
  -d '{
    "auditId": "[UUID-FROM-STEP-1]",
    "formState": {"niche":"home_services","step1":{"businessName":"Test Plumbing Co"},"step2":{},"step3":{},"step4":{},"step5":{},"step6":{},"step7":{},"step8":{}},
    "scores": {"overall":42,"technology":35,"leads":50,"scheduling":40,"communication":45,"followUp":30,"operations":55,"financial":40,"categories":[{"category":"technology","label":"Technology","score":35,"weight":15},{"category":"leads","label":"Lead Management","score":50,"weight":20},{"category":"scheduling","label":"Scheduling","score":40,"weight":15},{"category":"communication","label":"Communication","score":45,"weight":10},{"category":"followUp","label":"Follow-Up","score":30,"weight":15},{"category":"operations","label":"Operations","score":55,"weight":10},{"category":"financial","label":"Financial","score":40,"weight":15}]}
  }'
```

3. **Wait 30-60 seconds** for the webhook to fire and the email to arrive.

4. **Check your ADMIN_EMAIL inbox** (the email address stored as the ADMIN_EMAIL secret):
   - Subject should be: `New Audit: Test User — Home Services (42/100)`
   - From should be: `E&PSystems <onboarding@resend.dev>`
   - Body should contain: contact info, overall score, category scores, AI recommendations, "View Full Report" button

5. **Verify email_status** was updated in the database:
   - Go to Supabase Dashboard -> Table Editor -> audits
   - Find the test row and check email_status is 'sent'

6. **Verify audit_reports** has the AI report:
   - Go to Table Editor -> audit_reports
   - Confirm a row exists with the test audit_id and a JSONB report column

**If email does NOT arrive:**
- Check Supabase Dashboard -> Edge Functions -> send-notification -> Logs for errors
- Check that ADMIN_EMAIL matches your Resend account's verified email
- Check that RESEND_API_KEY is correct
- Check that the webhook is configured and enabled in Database -> Webhooks

Type "email verified" if admin email arrived with correct content, or describe any issues.
  </action>
  <verify>
- Admin email received within 60 seconds
- Email contains: contact name, email, phone, niche, overall score, category scores, AI recommendations, report link
- email_status is 'sent' in audits table
- audit_reports table has AI report row
  </verify>
  <done>Admin email delivered with all required content. email_status updated to 'sent'. audit_reports table populated. Phase 3 EMAIL-01 verified end-to-end. EMAIL-02 documented as deferred (requires custom Resend domain).</done>
</task>

</tasks>

<verification>
EMAIL-01 verification:
- Admin email arrives within 60 seconds of report_status changing to 'completed'
- Email contains: contact name, email, phone, niche, overall score, category scores, AI recommendations, report link
- email_status updated to 'sent' in audits table
- Disabling the webhook stops emails without affecting audit submission or report generation

EMAIL-02 documentation:
- EMAIL-02 (user email) is formally deferred — requires custom Resend domain verification before it can deliver to arbitrary email addresses
- The send-notification function was intentionally built with admin-only email support
- No user email code exists in the codebase
- The 'partial' email_status value was removed since only one email type is sent

Phase 3 success criteria status:
1. "Inserting a row triggers admin email within 60 seconds" — VERIFIED via curl test
2. "Inserting a row triggers user email" — DEFERRED (EMAIL-02 requires custom domain)
3. "Emails land in inbox (not spam)" — VERIFIED for admin email; user email deferred
4. "Disabling webhook stops emails" — VERIFIABLE by toggling webhook in Dashboard
</verification>

<success_criteria>
- Admin receives email notification when report_status changes to 'completed'
- Email contains all required content (contact info, scores, AI recommendations, report link)
- email_status tracks delivery outcome (sent/failed)
- Database Webhook is the sole coupling point — disabling it stops emails without side effects
- EMAIL-02 is documented as deferred (not missing, not forgotten — intentionally postponed per user decision)
</success_criteria>

<output>
After completion, create `.planning/phases/03-email-webhook/03-03-SUMMARY.md`
</output>
