---
phase: 02-ai-report-edge-function
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified: []
autonomous: false
requirements: [AI-01, AI-02, AI-03, AI-04, SEC-04]

must_haves:
  truths:
    - "A curl request to the deployed generate-report function returns valid JSON with executiveSummary, gaps, quickWins, and strategicRecommendations"
    - "The returned report text references the specific niche in its framing"
    - "The returned report text references weak-scoring categories by name and score"
    - "The ANTHROPIC_API_KEY is not present in the built JS bundle"
  artifacts:
    - path: "supabase/functions/generate-report/index.ts"
      provides: "Deployed edge function on Supabase"
  key_links:
    - from: "Supabase edge function runtime"
      to: "supabase/functions/generate-report/index.ts"
      via: "MCP deploy_edge_function"
      pattern: "generate-report"
---

<objective>
Deploy the generate-report edge function to Supabase via MCP and verify it works end-to-end with a curl test using sample audit data.

Purpose: The deployed function must be independently testable via HTTP before any frontend changes. This plan confirms the entire AI pipeline works: sanitized input goes in, personalized structured JSON comes out, and status column gets updated.

Output: Live edge function at `https://qyktrwpgfyvgdnexzcpr.supabase.co/functions/v1/generate-report`, verified via curl.
</objective>

<execution_context>
@C:/Users/Emil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Emil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ai-report-edge-function/02-CONTEXT.md
@.planning/phases/02-ai-report-edge-function/02-RESEARCH.md
@.planning/phases/02-ai-report-edge-function/02-01-SUMMARY.md
@supabase/functions/generate-report/index.ts
@supabase/functions/_shared/cors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy generate-report edge function via MCP</name>
  <files></files>
  <action>
1. **Read the edge function files** to pass to MCP deploy:
   - Read `supabase/functions/generate-report/index.ts` (entrypoint)
   - Read `supabase/functions/_shared/cors.ts` (dependency)

2. **Deploy via MCP** `deploy_edge_function`:
   - `project_id`: `qyktrwpgfyvgdnexzcpr`
   - `name`: `generate-report`
   - `entrypoint_path`: `index.ts`
   - `verify_jwt`: `true` (locked: function requires valid JWT for security)
   - `files`: Include both `index.ts` and `../_shared/cors.ts` with their contents

3. **Verify deployment** via MCP `list_edge_functions`:
   - Confirm `generate-report` appears in the function list
   - Confirm status is active

**Important:** The ANTHROPIC_API_KEY must already be set as a Supabase project secret before this step. If the user has not done this yet, pause and request it (user_setup from Plan 01 should have handled this).
  </action>
  <verify>
  - MCP list_edge_functions shows `generate-report` in the list
  - Function status is active/deployed
  </verify>
  <done>generate-report edge function is deployed and live on Supabase</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify edge function via curl with sample audit data</name>
  <files>No files modified — deployment verification only</files>
  <action>
    Pause for human verification. What was built: The generate-report edge function has been deployed to Supabase. It accepts audit form data and scores, calls Claude Haiku 4.5, and returns a structured JSON report with personalized gaps, quick wins, and strategic recommendations.

    Before pausing, the executor should:

    1. **Get the publishable anon key** via MCP `get_publishable_keys` for project `qyktrwpgfyvgdnexzcpr`

    2. **Run the curl test** with a home services sample payload (low scores to trigger more gaps). Use the anon key as the Bearer token:

    ```bash
    curl -s -X POST \
      "https://qyktrwpgfyvgdnexzcpr.supabase.co/functions/v1/generate-report" \
      -H "Authorization: Bearer <ANON_KEY>" \
      -H "Content-Type: application/json" \
      -d '{
        "auditId": "<use-a-real-audit-id-from-supabase-or-a-test-uuid>",
        "formState": {
          "niche": "home_services",
          "step1": { "businessName": "Acme Plumbing & Heating", "contactName": "John", "email": "john@acme.com", "phone": "555-1234" },
          "step2": { "primaryCRM": "None", "crmSatisfaction": 1, "toolsUsed": ["Google Docs"], "techFrustrations": "Our scheduling software crashes constantly and we lose customer data weekly" },
          "step3": { "leadSources": ["Google"], "responseSpeed": "Next business day or later", "leadTracking": "Notebook/whiteboard", "conversionRate": "No — we don't track this", "googleReviews": "0–25", "reviewAutomation": "No", "missedCallHandling": "We probably miss some and never follow up" },
          "step4": { "schedulingMethod": "Phone calls and a whiteboard", "dispatchMethod": "Manual — office calls/texts techs", "routeOptimization": "No", "realTimeTracking": "No", "capacityPlanning": "We often overbook or underbook", "emergencyHandling": "It's chaotic" },
          "step5": { "internalComms": "Phone calls", "afterHoursComms": "After-hours calls go unanswered", "clientPortal": "No and not a priority", "appointmentReminders": "No reminders sent", "onTheWayNotifications": "No", "jobCompletionComms": "No formal communication" },
          "step6": { "repeatBusinessPercent": "Under 10%", "postJobFollowUp": "Nothing formal", "maintenanceReminders": "No", "serviceAgreements": "No", "estimateFollowUp": "We don't follow up", "warrantyTracking": "We don't track this" },
          "step7": { "kpisTracked": [], "performanceMeasurement": "No formal measurement", "jobCosting": "We mostly guess", "inventoryManagement": "No formal tracking", "timeTracking": "They don't log time", "qualityControl": "No formal process" },
          "step8": { "paymentMethods": ["Cash"], "estimateProcess": "Paper/verbal estimates", "pricingModel": "No standardized pricing", "invoiceTiming": "It varies a lot", "collectionsProcess": "We chase when we remember", "financialReview": "We check the bank account", "biggestChallenge": "Everything is manual and disorganized, we lose track of jobs constantly" }
        },
        "scores": {
          "overall": 12,
          "technology": 17,
          "leads": 10,
          "scheduling": 0,
          "communication": 6,
          "followUp": 3,
          "operations": 0,
          "financial": 11,
          "categories": [
            { "category": "scheduling", "label": "Scheduling & Dispatch", "score": 0, "weight": 15 },
            { "category": "operations", "label": "Operations & Accountability", "score": 0, "weight": 15 },
            { "category": "followUp", "label": "Follow-Up & Retention", "score": 3, "weight": 15 },
            { "category": "communication", "label": "Communication", "score": 6, "weight": 10 },
            { "category": "leads", "label": "Lead Funnel & Marketing", "score": 10, "weight": 20 },
            { "category": "financial", "label": "Financial Operations", "score": 11, "weight": 15 },
            { "category": "technology", "label": "Technology & Software", "score": 17, "weight": 10 }
          ]
        }
      }'
    ```

    3. **Verify the response** against all five phase success criteria:

    **Criterion 1:** Response contains `success: true` and `report` object with keys: `executiveSummary` (string), `gaps` (array), `quickWins` (array), `strategicRecommendations` (array). Each array item has `priority` and `cta` fields.

    **Criterion 2 (AI-02):** The `executiveSummary` or item descriptions reference "home services", "plumbing", or similar niche framing — NOT real estate language.

    **Criterion 3 (AI-03):** At least one gap or recommendation references a weak category by name (e.g., "Scheduling & Dispatch", "Operations & Accountability") and mentions its low score.

    **Criterion 4 (SEC-04):** The response text does NOT contain the email "john@acme.com", phone "555-1234", or contact name "John" anywhere — proving PII was excluded from the prompt.

    **Criterion 5 (SEC-04 bundle):** Run `npm run build` and verify: `grep -r "ANTHROPIC" dist/ | wc -l` returns 0 (the API key is not in the client bundle). Note: Phase 2 success criterion #5 says "OpenAI API key" but the project uses Anthropic — verify no ANTHROPIC_API_KEY in dist/.

    4. **Check report_status** was updated via MCP execute_sql:
    ```sql
    SELECT id, report_status FROM public.audits WHERE id = '<auditId-used-in-curl>' LIMIT 1;
    ```
    Expected: `report_status = 'completed'` (or 'pending' if auditId was a fake UUID that doesn't exist — status update is a no-op which is acceptable)

    5. **Optional: Run a second test with real_estate niche** to confirm niche switching works.

    Present all results to the user and ask for approval.
  </action>
  <verify>
    All five Phase 2 success criteria pass:
    1. curl returns valid JSON with executiveSummary, gaps, quickWins, strategicRecommendations
    2. Report text references home services niche
    3. Report text references weak categories by name and score
    4. No PII (email, phone, contactName) in response text
    5. No ANTHROPIC string in dist/ bundle
  </verify>
  <done>
    User types "approved" after all five criteria pass. Phase 2 is complete — the generate-report edge function is deployed and verified.
  </done>
</task>

</tasks>

<verification>
All five Phase 2 success criteria from ROADMAP.md:

1. **curl returns valid JSON report** — Response has `executiveSummary`, `gaps`, `quickWins`, `strategicRecommendations` sections with correct field shapes including `priority` and `cta` per item
2. **Niche-specific framing** — Report text references home services (or real estate if tested) industry context
3. **Score-aware recommendations** — Report references weak categories by name and their scores
4. **Sanitized inputs** — PII (email, phone, contactName) does not appear in the AI-generated text
5. **No API key in bundle** — `npm run build` + grep confirms no ANTHROPIC string in dist/
</verification>

<success_criteria>
- generate-report function is deployed and returns 200 with structured JSON on valid request
- Response matches the expected schema with all required fields
- Niche context is reflected in the AI output
- Weak categories are referenced by name
- No PII leaks into AI output
- ANTHROPIC_API_KEY not in client bundle
</success_criteria>

<output>
After completion, create `.planning/phases/02-ai-report-edge-function/02-02-SUMMARY.md`
</output>
